<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ | PMS</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0e17;--bg2:#111827;--card:#1a2332;--bdr:rgba(56,189,248,.08);--bdr2:rgba(56,189,248,.15);--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--blue:#38bdf8;--cyan:#22d3ee;--green:#34d399;--orange:#f59e0b;--red:#ef4444;--purple:#a78bfa;--sw:280px;--r:16px;--rs:10px}
body.light{--bg:#f0f4f8;--bg2:#ffffff;--card:#ffffff;--bdr:rgba(0,0,0,.08);--bdr2:rgba(0,0,0,.12);--t1:#1e293b;--t2:#475569;--t3:#94a3b8}
body.light .sidebar{background:#fff;border-color:rgba(0,0,0,.06)}
body.light .topbar{background:rgba(240,244,248,.92)}
body.light .login-card{background:rgba(255,255,255,.95)}
body.light .l-group input,body.light .l-group select,body.light .f-input,body.light .f-select,body.light .f-sel,body.light .f-search input{background:#f8fafc;border-color:rgba(0,0,0,.1);color:#1e293b}
body.light .st-card,body.light .card,body.light .board-col,body.light .b-card,body.light .fin-stat,body.light .dept-card,body.light .ai-card{background:#fff;border-color:rgba(0,0,0,.06)}
body.light .tbl thead th{background:#f8fafc}
body.light ::-webkit-scrollbar-thumb{background:#94a3b8}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Tajawal','Cairo',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden;transition:background .4s,color .4s}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--blue);border-radius:3px}
a{text-decoration:none;color:inherit}

/* LOGIN */
#loginPage{display:flex;align-items:center;justify-content:center;min-height:100vh;position:relative}
#loginPage.hidden{display:none}
.login-bg{position:fixed;inset:0;background-image:radial-gradient(rgba(56,189,248,.03) 1px,transparent 1px);background-size:40px 40px}
.login-glow1{position:fixed;width:500px;height:500px;background:radial-gradient(circle,rgba(14,165,233,.08),transparent 70%);top:-100px;right:-100px;border-radius:50%;animation:gf1 8s ease-in-out infinite}
.login-glow2{position:fixed;width:400px;height:400px;background:radial-gradient(circle,rgba(34,211,238,.06),transparent 70%);bottom:-80px;left:-80px;border-radius:50%;animation:gf2 10s ease-in-out infinite}
@keyframes gf1{0%,100%{transform:translate(0,0)}50%{transform:translate(-30px,20px)}}
@keyframes gf2{0%,100%{transform:translate(0,0)}50%{transform:translate(20px,-30px)}}
.login-box{position:relative;z-index:1;width:100%;max-width:440px;padding:20px}
.login-card{background:rgba(26,35,50,.9);backdrop-filter:blur(24px);border:1px solid var(--bdr2);border-radius:24px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:cIn .6s ease}
@keyframes cIn{from{opacity:0;transform:translateY(30px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo .icon{width:68px;height:68px;background:linear-gradient(135deg,#0ea5e9,#22d3ee);border-radius:18px;display:inline-flex;align-items:center;justify-content:center;font-size:30px;font-weight:900;color:#fff;margin-bottom:14px;box-shadow:0 8px 30px rgba(14,165,233,.3);position:relative;overflow:hidden}
.login-logo .icon::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.15) 50%,transparent 60%);animation:shm 3s infinite}
@keyframes shm{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.login-logo h2{font-size:22px;font-weight:800;font-family:'Cairo',sans-serif;background:linear-gradient(135deg,var(--t1),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-logo p{font-size:13px;color:var(--t3);margin-top:4px}
.l-hint{background:rgba(56,189,248,.05);border:1px solid rgba(56,189,248,.1);border-radius:10px;padding:10px 14px;margin-bottom:18px;font-size:13px;color:var(--t3)}
.l-hint b{color:var(--blue);cursor:pointer}
.l-err{display:none;padding:10px 14px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:10px;font-size:13px;color:var(--red);margin-bottom:14px}
.l-err.show{display:block;animation:shk .4s}
@keyframes shk{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-6px)}50%{transform:translateX(6px)}}
.l-group{margin-bottom:18px}
.l-group label{display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px}
.l-group input,.l-group select{width:100%;height:48px;background:var(--bg2);border:1.5px solid var(--bdr);border-radius:10px;padding:0 14px;color:var(--t1);font-size:15px;font-family:'Tajawal',sans-serif;direction:rtl;transition:.3s}
.l-group input:focus,.l-group select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(56,189,248,.1)}
.l-group select{appearance:none;cursor:pointer}
.l-btn{width:100%;height:50px;background:linear-gradient(135deg,#2563eb,#0ea5e9);border:none;border-radius:12px;color:#fff;font-size:17px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;transition:.3s;margin-top:6px}
.l-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(37,99,235,.4)}

/* SIDEBAR */
#app{display:none}#app.active{display:flex}
.sidebar{position:fixed;right:0;top:0;width:var(--sw);height:100vh;background:var(--bg2);border-left:1px solid var(--bdr);z-index:100;display:flex;flex-direction:column;transition:all .3s}
.sb-hd{padding:22px 18px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:12px}
.sb-logo{width:44px;height:44px;background:linear-gradient(135deg,#0ea5e9,#22d3ee);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fff;flex-shrink:0}
.sb-hd .title{font-size:16px;font-weight:800}.sb-hd .sub{font-size:11px;color:var(--t3)}
.sb-nav{flex:1;padding:14px 12px;overflow-y:auto}
.sb-sec{font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;padding:12px 12px 8px;font-weight:700}
.sb-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--rs);cursor:pointer;transition:.2s;font-size:15px;color:var(--t2);margin-bottom:2px}
.sb-item:hover{background:rgba(56,189,248,.06);color:var(--t1)}.sb-item.active{background:rgba(56,189,248,.1);color:var(--blue);font-weight:600}
.sb-item .ic{width:24px;text-align:center;font-size:20px}
.sb-ft{padding:16px 18px;border-top:1px solid var(--bdr);display:flex;align-items:center;gap:12px}
.sb-av{width:40px;height:40px;background:linear-gradient(135deg,var(--green),var(--cyan));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0}
.sb-ft .nm{font-size:14px;font-weight:700}.sb-ft .rl{font-size:11px;color:var(--t3)}
.sb-logout{margin-right:auto;cursor:pointer;font-size:20px;color:var(--t3)}.sb-logout:hover{color:var(--red)}

.main{margin-right:var(--sw);flex:1;min-height:100vh;display:flex;flex-direction:column}
.topbar{position:sticky;top:0;z-index:50;background:rgba(10,14,23,.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);padding:0 28px;height:60px;display:flex;align-items:center;justify-content:space-between;transition:all .3s}
.tb-r{display:flex;align-items:center;gap:12px}
.tb-menu{display:none;width:40px;height:40px;border-radius:8px;border:1px solid var(--bdr);background:var(--card);color:var(--t2);align-items:center;justify-content:center;cursor:pointer;font-size:18px}
.pg-title{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--t1),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tb-l{display:flex;align-items:center;gap:10px}
.tb-date{font-size:13px;color:var(--t3)}
.tb-btn{width:40px;height:40px;border-radius:8px;border:1px solid var(--bdr);background:var(--card);color:var(--t2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:.2s}
.tb-btn:hover{border-color:var(--blue);color:var(--blue)}

.page{display:none;padding:24px 28px;flex:1}.page.active{display:block}
.page-hd{margin-bottom:22px}.page-hd h1{font-size:26px;font-weight:800;font-family:'Cairo',sans-serif;margin-bottom:4px}.page-hd p{color:var(--t2);font-size:15px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:20px;margin-bottom:18px;transition:all .3s}.card:hover{border-color:var(--bdr2)}
.card-t{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;font-family:'Cairo',sans-serif}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid4{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px}
.st-card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:20px;position:relative;overflow:hidden;transition:.3s;cursor:pointer}
.st-card:hover{transform:translateY(-3px);border-color:var(--bdr2);box-shadow:0 8px 30px rgba(0,0,0,.2)}
.st-ic{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:10px}
.st-lb{font-size:13px;color:var(--t2);margin-bottom:4px}
.st-vl{font-size:28px;font-weight:800;font-family:'Cairo',sans-serif}
.st-trend{font-size:12px;margin-top:4px;display:flex;align-items:center;gap:3px}
.st-trend.up{color:var(--green)}.st-trend.down{color:var(--red)}.st-trend.neutral{color:var(--t3)}
.tbl-wrap{overflow-x:auto}
table.tbl{width:100%;border-collapse:collapse}
.tbl thead th{padding:14px;font-size:13px;font-weight:600;color:var(--t2);text-align:right;border-bottom:2px solid var(--bdr);background:var(--bg2);white-space:nowrap}
.tbl tbody tr{border-bottom:1px solid var(--bdr);transition:.2s}.tbl tbody tr:hover{background:rgba(56,189,248,.03)}
.tbl td{padding:14px;font-size:14px;vertical-align:middle}
.badge{display:inline-flex;align-items:center;gap:4px;padding:5px 14px;border-radius:7px;font-size:12px;font-weight:600;white-space:nowrap}
.badge.green{background:rgba(52,211,153,.1);color:var(--green)}.badge.blue{background:rgba(56,189,248,.1);color:var(--blue)}
.badge.orange{background:rgba(245,158,11,.1);color:var(--orange)}.badge.red{background:rgba(239,68,68,.1);color:var(--red)}
.badge.purple{background:rgba(167,139,250,.1);color:var(--purple)}.badge.gray{background:rgba(148,163,184,.1);color:var(--t2)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 24px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;transition:.3s}
.btn-primary{background:linear-gradient(135deg,#2563eb,#0ea5e9);color:#fff;box-shadow:0 4px 14px rgba(37,99,235,.3)}.btn-primary:hover{transform:translateY(-2px)}
.btn-ai{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;box-shadow:0 4px 14px rgba(124,58,237,.3);position:relative;overflow:hidden}
.btn-ai::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 30%,rgba(255,255,255,.1) 50%,transparent 70%);transform:translateX(-100%);animation:shm 3s infinite}
.btn-orange{background:var(--orange);color:#fff}
.btn-green{background:var(--green);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--bdr);color:var(--t2)}.btn-outline:hover{border-color:var(--blue);color:var(--blue)}
.act-btn{width:32px;height:32px;border-radius:7px;border:1px solid var(--bdr);background:var(--bg2);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:.2s}
.act-btn.del{color:var(--red)}.act-btn.del:hover{background:rgba(239,68,68,.1)}
.f-group{margin-bottom:14px}.f-label{display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:5px}
.f-input,.f-select{width:100%;height:44px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:0 12px;color:var(--t1);font-size:14px;font-family:'Tajawal',sans-serif;direction:rtl;transition:.3s}
.f-input:focus,.f-select:focus{outline:none;border-color:var(--blue)}.f-select{appearance:none;cursor:pointer}
.f-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.f-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.f-submit{width:100%;padding:12px;background:linear-gradient(135deg,#2563eb,#0ea5e9);border:none;border-radius:10px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;margin-top:6px}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.f-search{flex:1;min-width:180px;position:relative}
.f-search input{width:100%;height:42px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:0 14px 0 36px;color:var(--t1);font-size:14px;font-family:'Tajawal',sans-serif;direction:rtl}
.f-search input:focus{outline:none;border-color:var(--blue)}
.f-search .ic{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--t3);pointer-events:none;font-size:16px}
.f-sel{min-width:160px;height:42px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:0 14px;color:var(--t1);font-size:14px;font-family:'Tajawal',sans-serif;appearance:none;cursor:pointer;direction:rtl}.f-sel option{background:var(--bg2)}
.qf{display:inline-flex;align-items:center;gap:5px;padding:7px 18px;border-radius:8px;border:1px solid var(--bdr);background:var(--bg2);color:var(--t2);font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.qf:hover{border-color:var(--bdr2);color:var(--t1)}.qf.active{border-color:var(--blue);color:var(--blue);background:rgba(56,189,248,.08)}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:var(--card);border:1px solid var(--bdr2);border-radius:20px;padding:26px;max-width:540px;width:92%;max-height:85vh;overflow-y:auto;animation:mIn .3s ease}
.modal.wide{max-width:700px}
@keyframes mIn{from{opacity:0;transform:scale(.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.modal-hd h3{font-size:18px;font-weight:700;font-family:'Cairo',sans-serif}
.modal-x{width:32px;height:32px;background:var(--bg2);border:1px solid var(--bdr);border-radius:7px;color:var(--t2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.prog-bar{width:100%;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden}.prog-bar .fill{height:100%;border-radius:3px;transition:width .8s ease}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:12px 28px;border-radius:10px;font-size:14px;font-weight:700;font-family:'Tajawal',sans-serif;z-index:999;box-shadow:0 4px 20px rgba(52,211,153,.3);animation:cIn .3s}
.stars{display:inline-flex;direction:ltr;gap:1px}.star{font-size:18px;color:var(--t3)}.star.on{color:#fbbf24}
.board-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px}
.board-col{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden}
.board-col-hd{padding:14px;border-bottom:1px solid var(--bdr);font-weight:700;font-size:14px;display:flex;justify-content:space-between}
.board-col-hd .cnt{background:rgba(148,163,184,.1);padding:2px 8px;border-radius:5px;font-size:12px;color:var(--t3)}
.board-col-bd{padding:8px;min-height:80px;display:flex;flex-direction:column;gap:6px}
.b-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:14px;transition:.2s}.b-card:hover{border-color:var(--bdr2)}
.b-card-t{font-weight:700;font-size:14px;margin-bottom:4px}.b-card-m{display:flex;justify-content:space-between;font-size:11px;color:var(--t3)}
.gauge-wrap{display:flex;flex-direction:column;align-items:center;padding:16px}
.gauge-ct{position:relative;width:200px;height:200px}
.gauge-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.gauge-pct{font-size:32px;font-weight:900;font-family:'Cairo',sans-serif;color:var(--blue)}.gauge-lbl{font-size:11px;color:var(--t3)}
.fin-stat{display:flex;align-items:center;justify-content:space-between;padding:18px;background:var(--bg2);border:1px solid var(--bdr);border-radius:12px;margin-bottom:10px;transition:.2s}
.fin-stat:hover{border-color:var(--bdr2)}.fin-stat-l{display:flex;align-items:center;gap:10px}
.fin-dot{width:12px;height:12px;border-radius:50%}.fin-lbl{font-size:14px;color:var(--t2)}
.fin-val{font-size:22px;font-weight:800;font-family:'Cairo',sans-serif}
.dept-card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;margin-bottom:14px}
.dept-hd{padding:18px 20px;display:flex;align-items:center;gap:14px;cursor:pointer}.dept-hd:hover{background:rgba(56,189,248,.03)}
.dept-ic{width:44px;height:44px;border-radius:12px;background:rgba(56,189,248,.08);display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--blue)}
.dept-nm{font-size:16px;font-weight:700;font-family:'Cairo',sans-serif}.dept-cnt{font-size:13px;color:var(--t3)}
.dept-tgl{margin-right:auto;font-size:18px;color:var(--t3);transition:transform .3s}
.dept-card.open .dept-tgl{transform:rotate(180deg)}
.dept-bd{display:none;border-top:1px solid var(--bdr)}.dept-card.open .dept-bd{display:block}
.emp-row{display:flex;align-items:center;gap:14px;padding:16px 20px;border-bottom:1px solid var(--bdr)}.emp-row:last-child{border-bottom:none}
.emp-av{width:40px;height:40px;border-radius:10px;background:rgba(56,189,248,.1);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--blue)}
.emp-info{flex:1}.emp-nm{font-weight:700;font-size:15px}.emp-rl{font-size:12px;color:var(--t3)}
.ai-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rs);padding:16px;margin-bottom:10px}
.ai-card h4{font-size:14px;font-weight:700;margin-bottom:6px;color:var(--cyan)}.ai-card p{font-size:13px;line-height:1.8;color:var(--t2)}
.spinner{width:36px;height:36px;border:3px solid var(--bdr);border-top-color:var(--purple);border-radius:50%;animation:spn .8s linear infinite;margin:0 auto 14px}
@keyframes spn{to{transform:rotate(360deg)}}

/* DASHBOARD ENHANCEMENTS */
.dash-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin-bottom:20px}
.kpi-card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:22px;position:relative;overflow:hidden;transition:.3s;cursor:pointer}
.kpi-card:hover{transform:translateY(-4px);border-color:var(--bdr2);box-shadow:0 12px 40px rgba(0,0,0,.25)}
.kpi-card::before{content:'';position:absolute;top:0;right:0;left:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.kpi-card.blue::before{background:linear-gradient(90deg,var(--blue),var(--cyan))}
.kpi-card.green::before{background:linear-gradient(90deg,var(--green),#10b981)}
.kpi-card.orange::before{background:linear-gradient(90deg,var(--orange),#f97316)}
.kpi-card.red::before{background:linear-gradient(90deg,var(--red),#f43f5e)}
.kpi-card.purple::before{background:linear-gradient(90deg,var(--purple),#818cf8)}
.kpi-card.cyan::before{background:linear-gradient(90deg,var(--cyan),#06b6d4)}
.kpi-icon{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:12px}
.kpi-value{font-size:32px;font-weight:900;font-family:'Cairo',sans-serif;line-height:1;margin-bottom:5px}
.kpi-label{font-size:13px;color:var(--t2);margin-bottom:6px}
.kpi-trend{font-size:12px;display:flex;align-items:center;gap:4px}
.kpi-trend.up{color:var(--green)}.kpi-trend.down{color:var(--red)}.kpi-trend.neu{color:var(--t3)}
.kpi-sparkline{position:absolute;bottom:0;right:0;left:0;height:40px;opacity:.3}

/* INTERACTIVE CHART TABS */
.chart-tabs{display:flex;gap:6px;margin-bottom:14px;border-bottom:1px solid var(--bdr);padding-bottom:10px;flex-wrap:wrap}
.chart-tab{padding:6px 14px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;color:var(--t3);transition:.2s;border:none;background:none;font-family:'Tajawal',sans-serif}
.chart-tab:hover{color:var(--t1);background:rgba(56,189,248,.05)}
.chart-tab.active{color:var(--blue);background:rgba(56,189,248,.1)}
.chart-pane{display:none}.chart-pane.active{display:block;animation:fadeIn .3s ease}

/* ACTIVITY FEED */
.activity-feed{max-height:320px;overflow-y:auto;padding-right:4px}
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--bdr);position:relative}
.activity-item:last-child{border-bottom:none}
.activity-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:5px}
.activity-item .info{flex:1}
.activity-item .info .title{font-size:13px;font-weight:600;margin-bottom:2px}
.activity-item .info .sub{font-size:11px;color:var(--t3)}
.activity-line{position:absolute;right:4px;top:20px;bottom:-14px;width:2px;background:var(--bdr)}
.activity-item:last-child .activity-line{display:none}

/* QUICK ACTIONS */
.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px}
.qa-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);cursor:pointer;transition:.3s;font-family:'Tajawal',sans-serif;font-size:13px;font-weight:600;color:var(--t2)}
.qa-btn:hover{border-color:var(--bdr2);color:var(--t1);transform:translateY(-2px)}
.qa-btn .qa-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}

/* PROGRESS CARDS */
.proj-progress-card{background:var(--bg2);border:1px solid var(--bdr);border-radius:12px;padding:16px;margin-bottom:8px;transition:.2s}
.proj-progress-card:hover{border-color:var(--bdr2)}
.ppcard-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ppcard-name{font-weight:700;font-size:14px}
.ppcard-pct{font-weight:800;font-family:'Cairo',sans-serif;font-size:16px}
.ppcard-meta{display:flex;gap:8px;font-size:11px;color:var(--t3);margin-top:4px}

/* TIMELINE */
.dash-timeline{position:relative;padding-right:20px}
.tl-item{display:flex;gap:14px;margin-bottom:16px;position:relative}
.tl-item::before{content:'';position:absolute;right:-12px;top:8px;bottom:-16px;width:2px;background:var(--bdr)}
.tl-item:last-child::before{display:none}
.tl-dot{width:16px;height:16px;border-radius:50%;flex-shrink:0;margin-top:3px;border:2px solid var(--bg)}
.tl-content{flex:1}
.tl-title{font-size:13px;font-weight:700}
.tl-sub{font-size:11px;color:var(--t3);margin-top:2px}
.tl-time{font-size:11px;color:var(--t3);white-space:nowrap}

/* REPORTS PAGE */
.report-header{background:linear-gradient(135deg,var(--card),var(--bg2));border:1px solid var(--bdr);border-radius:var(--r);padding:24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px}
.report-header h2{font-size:20px;font-weight:800;font-family:'Cairo',sans-serif}
.report-tabs{display:flex;gap:4px;background:var(--bg2);border:1px solid var(--bdr);border-radius:12px;padding:4px;flex-wrap:wrap}
.r-tab{padding:8px 20px;border-radius:9px;font-size:13px;font-weight:700;cursor:pointer;color:var(--t3);transition:.2s;border:none;background:none;font-family:'Tajawal',sans-serif}
.r-tab.active{background:var(--card);color:var(--blue);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.r-tab:hover:not(.active){color:var(--t1)}
.report-section{display:none;animation:fadeIn .35s ease}
.report-section.active{display:block}
.metric-highlight{background:linear-gradient(135deg,var(--card),var(--bg2));border:1px solid var(--bdr);border-radius:var(--r);padding:20px;text-align:center;transition:.3s}
.metric-highlight:hover{border-color:var(--bdr2);transform:translateY(-2px)}
.metric-highlight .mh-value{font-size:36px;font-weight:900;font-family:'Cairo',sans-serif;margin-bottom:4px}
.metric-highlight .mh-label{font-size:13px;color:var(--t2)}
.metric-highlight .mh-icon{font-size:28px;margin-bottom:8px}
.report-export-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.rank-list{list-style:none}
.rank-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--bdr)}
.rank-item:last-child{border-bottom:none}
.rank-num{width:28px;height:28px;border-radius:50%;background:rgba(56,189,248,.1);color:var(--blue);font-weight:800;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.rank-num.gold{background:rgba(251,191,36,.1);color:#fbbf24}
.rank-num.silver{background:rgba(148,163,184,.1);color:#94a3b8}
.rank-num.bronze{background:rgba(245,158,11,.1);color:var(--orange)}
.rank-info{flex:1}
.rank-name{font-weight:700;font-size:14px}
.rank-sub{font-size:12px;color:var(--t3);margin-top:1px}
.rank-score{font-weight:800;font-family:'Cairo',sans-serif;font-size:16px}
.heat-map{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.heat-cell{height:22px;border-radius:3px;transition:.2s;cursor:pointer;position:relative}
.heat-cell:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 5px);right:50%;transform:translateX(50%);background:var(--card);border:1px solid var(--bdr);border-radius:6px;padding:4px 8px;font-size:11px;white-space:nowrap;z-index:10;pointer-events:none}
.summary-box{background:linear-gradient(135deg,rgba(56,189,248,.05),rgba(34,211,238,.03));border:1px solid rgba(56,189,248,.1);border-radius:12px;padding:20px;margin-bottom:16px}
.summary-box h4{font-size:15px;font-weight:700;color:var(--blue);margin-bottom:10px;font-family:'Cairo',sans-serif}
.summary-box p{font-size:13px;line-height:2;color:var(--t2)}
.compare-bar{display:flex;height:24px;border-radius:6px;overflow:hidden;margin-top:8px}
.compare-bar span{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;transition:width .8s ease;min-width:0;overflow:hidden}

@media(max-width:900px){.sidebar{transform:translateX(100%)}.sidebar.open{transform:translateX(0)}.main{margin-right:0}.tb-menu{display:flex}.grid2,.grid3{grid-template-columns:1fr}.f-row,.f-row3{grid-template-columns:1fr}}
@media(max-width:600px){.page{padding:16px}.topbar{padding:0 14px}.grid4,.dash-kpi-grid{grid-template-columns:1fr 1fr}.quick-actions{grid-template-columns:repeat(3,1fr)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}.anim{animation:fadeIn .4s ease both}
@keyframes countUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.count-anim{animation:countUp .5s ease both}
</style></head><body>

<div id="loginPage">
<div class="login-bg"></div><div class="login-glow1"></div><div class="login-glow2"></div>
<div class="login-box"><div class="login-card">
<div class="login-logo"><div class="icon">Ù…</div><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2><p>Project Management System</p></div>
<div class="l-hint">ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©: <b onclick="document.getElementById('lu').value='admin'">admin</b> | <b onclick="document.getElementById('lp').value='admin123'">admin123</b></div>
<div class="l-err" id="lErr"></div>
<div class="l-group"><label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="lu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"></div>
<div class="l-group"><label>ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="lp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
<button class="l-btn" onclick="doLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div></div></div>

<div id="app"><aside class="sidebar" id="sidebar">
<div class="sb-hd"><div class="sb-logo">Ù…</div><div><div class="title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div><div class="sub">PMS v2.0</div></div></div>
<nav class="sb-nav">
<div class="sb-sec">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
<div class="sb-item active" onclick="goTo('dashboard')"><span class="ic">ğŸ“Š</span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
<div class="sb-item" onclick="goTo('calendar')"><span class="ic">ğŸ“…</span>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</div>
<div class="sb-item" onclick="goTo('projects')"><span class="ic">ğŸ“</span>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
<div class="sb-item" onclick="goTo('tasks')"><span class="ic">âœ…</span>Ø§Ù„Ù…Ù‡Ø§Ù…</div>
<div class="sb-sec">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
<div class="sb-item" onclick="goTo('finance')"><span class="ic">ğŸ’°</span>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
<div class="sb-item" onclick="goTo('hr')"><span class="ic">ğŸ‘¥</span>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</div>
<div class="sb-item" onclick="goTo('evaluations')"><span class="ic">â­</span>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
<div class="sb-item" onclick="goTo('reports')"><span class="ic">ğŸ“‹</span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
<div class="sb-sec">Ø§Ù„Ù†Ø¸Ø§Ù…</div>
<div class="sb-item" onclick="goTo('users')"><span class="ic">ğŸ”‘</span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
<div class="sb-item" onclick="goTo('settings')"><span class="ic">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
</nav>
<div class="sb-ft"><div class="sb-av" id="sbAv">Ù…</div><div><div class="nm" id="sbNm">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div><div class="rl" id="sbRl">Super Admin</div></div><span class="sb-logout" onclick="doLogout()">ğŸšª</span></div>
</aside>
<div class="main">
<header class="topbar">
<div class="tb-r"><button class="tb-menu" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button><span class="pg-title" id="pgTitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></div>
<div class="tb-l"><span class="tb-date" id="todayDate"></span><button class="tb-btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button><button class="tb-btn">ğŸ””</button></div>
</header>

<!-- ===================== DASHBOARD ===================== -->
<div class="page active" id="pg-dashboard">
<div class="page-hd">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
    <div><h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1><p>Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ù‡Ø§Ù…</p></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-ai" onclick="showAI('dash')">âœ¨ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
      <button class="btn btn-outline" onclick="renderDash()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions anim" id="quickActions">
  <button class="qa-btn" onclick="showModal('projModal')"><div class="qa-icon" style="background:rgba(56,189,248,.1)">ğŸ“</div>Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
  <button class="qa-btn" onclick="showModal('taskModal')"><div class="qa-icon" style="background:rgba(52,211,153,.1)">âœ…</div>Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
  <button class="qa-btn" onclick="goTo('reports')"><div class="qa-icon" style="background:rgba(167,139,250,.1)">ğŸ“‹</div>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button class="qa-btn" onclick="goTo('finance')"><div class="qa-icon" style="background:rgba(245,158,11,.1)">ğŸ’°</div>Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
  <button class="qa-btn" onclick="goTo('hr')"><div class="qa-icon" style="background:rgba(239,68,68,.1)">ğŸ‘¥</div>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</button>
  <button class="qa-btn" onclick="goTo('evaluations')"><div class="qa-icon" style="background:rgba(34,211,238,.1)">â­</div>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
</div>

<!-- KPI Cards -->
<div class="dash-kpi-grid anim" id="dashKPI"></div>

<!-- Main Charts Row -->
<div class="grid2">
  <div class="card">
    <div class="chart-tabs">
      <button class="chart-tab active" onclick="switchDashChart('overview','proj')">ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
      <button class="chart-tab" onclick="switchDashChart('tasks','proj')">âœ… Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      <button class="chart-tab" onclick="switchDashChart('dept','proj')">ğŸ¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
    </div>
    <div class="chart-pane active" id="pane-proj-overview"><canvas id="chProj" height="220"></canvas></div>
    <div class="chart-pane" id="pane-proj-tasks"><canvas id="chTask2" height="220"></canvas></div>
    <div class="chart-pane" id="pane-proj-dept"><canvas id="chDept" height="220"></canvas></div>
  </div>
  <div class="card">
    <div class="chart-tabs">
      <button class="chart-tab active" onclick="switchDashChart('workload','right')">ğŸ“ˆ Ø¹Ø¨Ø¡ Ø§Ù„Ø¹Ù…Ù„</button>
      <button class="chart-tab" onclick="switchDashChart('pareto','right')">ğŸ“Š Ø¨Ø§Ø±ÙŠØªÙˆ</button>
      <button class="chart-tab" onclick="switchDashChart('trend','right')">ğŸ“‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡</button>
    </div>
    <div class="chart-pane active" id="pane-right-workload"><canvas id="chWork" height="220"></canvas></div>
    <div class="chart-pane" id="pane-right-pareto"><canvas id="chPareto" height="220"></canvas></div>
    <div class="chart-pane" id="pane-right-trend"><canvas id="chTrend" height="220"></canvas></div>
  </div>
</div>

<!-- Progress + Activity -->
<div class="grid2">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="card-t" style="margin:0">ğŸ”„ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
      <select class="f-sel" style="width:auto;height:34px;font-size:12px" onchange="renderProjFilter(this.value)" id="progFilter">
        <option value="all">Ø§Ù„ÙƒÙ„</option><option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option>
      </select>
    </div>
    <div id="projProgressList"></div>
  </div>
  <div class="card">
    <div class="card-t">ğŸ• Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</div>
    <div class="activity-feed" id="activityFeed"></div>
  </div>
</div>

<!-- Risk + Timeline -->
<div class="grid2">
  <div class="card">
    <div class="card-t">âš ï¸ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</div>
    <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th><th>Ø§Ù„ØªÙˆØµÙŠØ©</th></tr></thead><tbody id="riskBody"></tbody></table></div>
  </div>
  <div class="card">
    <div class="card-t">ğŸ“… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
    <div class="dash-timeline" id="taskTimeline"></div>
  </div>
</div>

<!-- Chart: Tasks + Full Progress -->
<div class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div class="card-t" style="margin:0">ğŸ“Š ØªÙ‚Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
  </div>
  <div id="dashProgEmpty" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯</div>
  <canvas id="chProgress" height="150" style="display:none"></canvas>
</div>
</div>

<!-- ===================== CALENDAR ===================== -->
<div class="page" id="pg-calendar">
<div class="page-hd"><h1>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</h1><p>Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ</p></div>
<div class="filter-bar"><select class="f-sel" id="calProj" onchange="renderCal()"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</option></select><button class="btn btn-primary" onclick="var d=new Date();calM=d.getMonth();calY=d.getFullYear();renderCal()">Ø§Ù„ÙŠÙˆÙ…</button></div>
<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><button class="tb-btn" onclick="calNav(-1)">â†’</button><span style="font-size:18px;font-weight:700;font-family:Cairo" id="calTitle"></span><button class="tb-btn" onclick="calNav(1)">â†</button></div>
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;font-size:13px;color:var(--t3);margin-bottom:6px"><span>Ø³Ø¨Øª</span><span>Ø£Ø­Ø¯</span><span>Ø§Ø«Ù†ÙŠÙ†</span><span>Ø«Ù„Ø§Ø«Ø§Ø¡</span><span>Ø£Ø±Ø¨Ø¹Ø§Ø¡</span><span>Ø®Ù…ÙŠØ³</span><span>Ø¬Ù…Ø¹Ø©</span></div>
<div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px"></div></div></div>

<!-- ===================== PROJECTS ===================== -->
<div class="page" id="pg-projects">
<div class="page-hd"><h1>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</p></div>
<div style="margin-bottom:16px"><button class="btn btn-primary" onclick="showModal('projModal')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</button></div>
<div class="filter-bar"><div class="f-search"><input placeholder="Ø¨Ø­Ø«..." id="projSearch" oninput="renderProjects()"><span class="ic">ğŸ”</span></div><select class="f-sel" onchange="renderProjects()" id="projStat"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option><option value="Ù…Ø³ÙˆØ¯Ø©">Ù…Ø³ÙˆØ¯Ø©</option></select></div>
<div class="card"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¯ÙŠØ±</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th><th>Ø§Ù„ØªÙ‚Ø¯Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="projBody"></tbody></table></div></div></div>

<!-- ===================== TASKS ===================== -->
<div class="page" id="pg-tasks">
<div class="page-hd"><h1>Ø§Ù„Ù…Ù‡Ø§Ù…</h1><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</p></div>
<div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap"><button class="btn btn-primary" onclick="showModal('taskModal')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button><div style="display:flex;border:1px solid var(--bdr);border-radius:8px;overflow:hidden"><button class="qf active" id="tv-table" onclick="switchTV('table')" style="border:0;border-radius:0">âŠ Ø¬Ø¯ÙˆÙ„</button><button class="qf" id="tv-board" onclick="switchTV('board')" style="border:0;border-radius:0">âŠŸ Ù„ÙˆØ­Ø©</button></div></div>
<div class="filter-bar"><div class="f-search"><input placeholder="Ø¨Ø­Ø«..." id="taskSearch" oninput="renderTasks()"><span class="ic">ğŸ”</span></div><select class="f-sel" id="taskStatF" onchange="renderTasks()"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option><option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option></select></div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px"><button class="qf active" id="qf-all" onclick="taskQF('all')">â˜° Ø§Ù„ÙƒÙ„</button><button class="qf" id="qf-overdue" onclick="taskQF('overdue')">â± Ù…ØªØ£Ø®Ø±Ø©</button><button class="qf" id="qf-priority" onclick="taskQF('priority')">â­ Ø¹Ø§Ù„ÙŠØ©</button></div>
<div id="taskTV"><div class="card"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ù…ÙƒÙ„Ù</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="taskBody"></tbody></table></div></div></div>
<div id="taskBV" style="display:none"><div class="board-cols" id="boardCols"></div></div></div>

<!-- ===================== FINANCE ===================== -->
<div class="page" id="pg-finance">
<div class="page-hd"><h1>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h1><p>Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p></div>
<select class="f-sel" style="width:100%;margin-bottom:18px;height:46px" id="finProj" onchange="renderFinance(parseInt(this.value))"></select>
<div class="grid2"><div class="card" style="padding:24px"><div class="card-t">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</div><div id="finProjName" style="font-size:18px;font-weight:800;font-family:Cairo;margin-bottom:16px;color:var(--blue)"></div><div id="finStats"></div></div><div class="card" style="padding:24px"><div class="card-t">ğŸ“ˆ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</div><div class="gauge-wrap"><div class="gauge-ct"><canvas id="gaugeChart"></canvas><div class="gauge-center"><div class="gauge-pct" id="gaugePct">0%</div><div class="gauge-lbl">Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</div></div></div></div></div></div>
<div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px"><div class="card-t" style="margin:0">ğŸ’µ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div><button class="btn btn-orange" onclick="showModal('expModal')">+ Ù…ØµØ±ÙˆÙ</button></div><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="expBody"></tbody></table></div></div>
<div class="card"><div class="card-t">ğŸ“„ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody id="finSummary"></tbody></table></div></div></div>

<!-- ===================== HR ===================== -->
<div class="page" id="pg-hr">
<div class="page-hd"><h1>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h1><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p></div>
<div style="margin-bottom:16px"><button class="btn btn-ai" onclick="showAI('hr')">âœ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button></div>
<div class="filter-bar"><div class="f-search"><input placeholder="Ø¨Ø­Ø«..." id="hrSearch" oninput="renderHR()"><span class="ic">ğŸ”</span></div><select class="f-sel" id="hrDept" onchange="renderHR()"><option value="all">Ø§Ù„ÙƒÙ„</option><option>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option><option>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option><option>ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option><option>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option><option>Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©</option></select></div>
<div class="grid4" id="hrStats"></div>
<div id="hrDepts" style="margin-top:18px"></div>
<div class="card" style="margin-top:18px"><div class="card-t">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªÙˆÙØ±</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ù‚Ø³Ù…</th></tr></thead><tbody id="hrBody"></tbody></table></div></div></div>

<!-- ===================== EVALUATIONS ===================== -->
<div class="page" id="pg-evaluations">
<div class="page-hd"><h1>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h1><p>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡</p></div>
<div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap"><button class="btn btn-ai" onclick="showAI('eval')">âœ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button><button class="btn btn-primary" onclick="showModal('evalModal')">+ ØªÙ‚ÙŠÙŠÙ…</button></div>
<div class="filter-bar"><div class="f-search"><input placeholder="Ø¨Ø­Ø«..." id="evalSearch" oninput="renderEvals()"><span class="ic">ğŸ”</span></div></div>
<div class="card"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø©</th><th>Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="evalBody"></tbody></table></div></div></div>

<!-- ===================== REPORTS ===================== -->
<div class="page" id="pg-reports">
<div class="page-hd">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
    <div><h1>ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1><p>ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªØ¹Ù…Ù‚Ø©</p></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-ai" onclick="showAI('reports')">âœ¨ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</button>
      <button class="btn btn-outline" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </div>
</div>

<div class="report-tabs">
  <button class="r-tab active" onclick="switchReport('overview')">ğŸ  Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
  <button class="r-tab" onclick="switchReport('projects')">ğŸ“ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
  <button class="r-tab" onclick="switchReport('tasks')">âœ… Ø§Ù„Ù…Ù‡Ø§Ù…</button>
  <button class="r-tab" onclick="switchReport('financial')">ğŸ’° Ù…Ø§Ù„ÙŠ</button>
  <button class="r-tab" onclick="switchReport('performance')">â­ Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
</div>

<!-- OVERVIEW REPORT -->
<div class="report-section active" id="rep-overview">
  <div class="grid4" id="repKPIs" style="margin:16px 0"></div>
  <div class="grid2">
    <div class="card"><div class="card-t">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</div><canvas id="repProjChart" height="220"></canvas></div>
    <div class="card"><div class="card-t">âœ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><canvas id="repTaskChart" height="220"></canvas></div>
  </div>
  <div class="grid2">
    <div class="card">
      <div class="card-t">ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ø¯Ø§Ø¡Ù‹</div>
      <ul class="rank-list" id="topPerformers"></ul>
    </div>
    <div class="card">
      <div class="card-t">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</div>
      <div id="perfSummary"></div>
    </div>
  </div>
</div>

<!-- PROJECTS REPORT -->
<div class="report-section" id="rep-projects">
  <div class="grid3" id="repProjMetrics" style="margin-bottom:16px"></div>
  <div class="card">
    <div class="card-t">ğŸ“ ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
    <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¯ÙŠØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th><th>Ø§Ù„ØªÙ‚Ø¯Ù…</th><th>Ø§Ù„Ù…Ù‡Ø§Ù…</th><th>Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th><th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th></tr></thead><tbody id="repProjBody"></tbody></table></div>
  </div>
  <div class="grid2">
    <div class="card"><div class="card-t">ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù‚Ø§Ø±Ù†</div><canvas id="repProjProgress" height="200"></canvas></div>
    <div class="card"><div class="card-t">âš ï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</div><canvas id="repRiskChart" height="200"></canvas></div>
  </div>
</div>

<!-- TASKS REPORT -->
<div class="report-section" id="rep-tasks">
  <div class="grid4" id="repTaskMetrics" style="margin-bottom:16px"></div>
  <div class="grid2">
    <div class="card"><div class="card-t">ğŸ“Š Ø§Ù„Ù…Ù‡Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</div><canvas id="repTaskStatus" height="220"></canvas></div>
    <div class="card"><div class="card-t">ğŸ‘¥ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div><canvas id="repTaskAssign" height="220"></canvas></div>
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="card-t" style="margin:0">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
      <select class="f-sel" style="width:auto;height:34px;font-size:12px" id="repTaskFilter" onchange="renderRepTaskTable()">
        <option value="all">Ø§Ù„ÙƒÙ„</option><option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option><option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
      </select>
    </div>
    <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…ÙƒÙ„Ù</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th></tr></thead><tbody id="repTaskTable"></tbody></table></div>
  </div>
</div>

<!-- FINANCIAL REPORT -->
<div class="report-section" id="rep-financial">
  <div class="grid3" id="repFinMetrics" style="margin-bottom:16px"></div>
  <div class="grid2">
    <div class="card"><div class="card-t">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div><canvas id="repFinChart" height="220"></canvas></div>
    <div class="card"><div class="card-t">ğŸ• ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div><canvas id="repExpChart" height="220"></canvas></div>
  </div>
  <div class="card">
    <div class="card-t">ğŸ“‹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</div>
    <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="repFinTable"></tbody></table></div>
  </div>
</div>

<!-- PERFORMANCE REPORT -->
<div class="report-section" id="rep-performance">
  <div class="grid4" id="repPerfMetrics" style="margin-bottom:16px"></div>
  <div class="grid2">
    <div class="card">
      <div class="card-t">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
      <ul class="rank-list" id="repRankList"></ul>
    </div>
    <div class="card"><div class="card-t">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div><canvas id="repPerfChart" height="220"></canvas></div>
  </div>
  <div class="card">
    <div class="card-t">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…</div>
    <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th></tr></thead><tbody id="repPerfTable"></tbody></table></div>
  </div>
</div>
</div>

<!-- ===================== USERS ===================== -->
<div class="page" id="pg-users">
<div class="page-hd"><h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1><p>Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p></div>
<div style="margin-bottom:16px"><button class="btn btn-primary" onclick="showModal('userModal')">+ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button></div>
<div class="filter-bar"><div class="f-search"><input placeholder="Ø¨Ø­Ø«..." id="userSearch" oninput="renderUsers()"><span class="ic">ğŸ”</span></div><select class="f-sel" id="userRoleF" onchange="renderUsers()"><option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option><option value="super_admin">Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…</option><option value="project_manager">Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹</option><option value="employee">Ù…ÙˆØ¸Ù</option></select></div>
<div class="grid4" id="userStats"></div>
<div class="card" style="margin-top:18px"><div class="tbl-wrap"><table class="tbl"><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="userBody"></tbody></table></div></div></div>

<!-- ===================== SETTINGS ===================== -->
<div class="page" id="pg-settings">
<div class="page-hd"><h1>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1><p>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p></div>
<div class="card"><div class="card-t">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</div>
<div class="f-group"><label class="f-label">Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</label><input class="f-input" value="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹"></div>
<div class="f-group"><label class="f-label">Ø§Ù„ÙˆØ¶Ø¹</label><select class="f-select" onchange="if(this.value==='light'){document.body.classList.add('light');isDark=false}else{document.body.classList.remove('light');isDark=true};document.getElementById('themeBtn').textContent=isDark?'ğŸŒ™':'â˜€ï¸'"><option value="dark">Ø¯Ø§ÙƒÙ†</option><option value="light">ÙØ§ØªØ­</option></select></div>
<button class="f-submit" onclick="toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª')">Ø­ÙØ¸</button></div></div>

</div></div>

<!-- MODALS -->
<div class="modal-bg" id="projModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal"><div class="modal-hd"><h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</h3><button class="modal-x" onclick="hideModal('projModal')">âœ•</button></div>
<div class="f-group"><label class="f-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><input class="f-input" id="pName"></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ù…Ø¯ÙŠØ±</label><select class="f-select" id="pMgr"></select></div><div class="f-group"><label class="f-label">Ø§Ù„Ù‚Ø³Ù…</label><select class="f-select" id="pDept"><option>ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option><option>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option><option>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option><option>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option><option>Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©</option></select></div></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><select class="f-select" id="pStat"><option>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option>Ù…Ø¹ØªÙ…Ø¯</option><option>Ù…Ø³ÙˆØ¯Ø©</option></select></div><div class="f-group"><label class="f-label">Ø§Ù„Ù…Ø®Ø§Ø·Ø±</label><select class="f-select" id="pRisk"><option>Ù…Ù†Ø®ÙØ¶</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ø¹Ø§Ù„ÙŠ</option></select></div></div>
<div class="f-group"><label class="f-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø±.Ø¹)</label><input type="number" class="f-input" id="pBudget" placeholder="0" style="text-align:left;font-family:Cairo;font-weight:700"></div>
<button class="f-submit" onclick="addProject()">Ø­ÙØ¸</button></div></div>

<div class="modal-bg" id="taskModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal"><div class="modal-hd"><h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</h3><button class="modal-x" onclick="hideModal('taskModal')">âœ•</button></div>
<div class="f-group"><label class="f-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</label><input class="f-input" id="tName"></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><select class="f-select" id="tProj"></select></div><div class="f-group"><label class="f-label">Ø§Ù„Ù…ÙƒÙ„Ù</label><select class="f-select" id="tAssign"></select></div></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input type="date" class="f-input" id="tDate"></div><div class="f-group"><label class="f-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><select class="f-select" id="tStat"><option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option><option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option></select></div></div>
<div class="f-group"><label class="f-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label><select class="f-select" id="tPri"><option value="normal">Ø¹Ø§Ø¯ÙŠØ©</option><option value="high">Ø¹Ø§Ù„ÙŠØ©</option><option value="urgent">Ø¹Ø§Ø¬Ù„Ø©</option></select></div>
<button class="f-submit" onclick="addTask()">Ø­ÙØ¸</button></div></div>

<div class="modal-bg" id="expModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal"><div class="modal-hd"><h3>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3><button class="modal-x" onclick="hideModal('expModal')">âœ•</button></div>
<div class="f-group"><label class="f-label">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="number" class="f-input" id="eBudget" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹" style="text-align:left;font-family:Cairo;font-weight:700"></div>
<div class="f-group"><label class="f-label">Ø§Ù„Ù†ÙˆØ¹</label><select class="f-select" id="eType"><option>Ù…Ø´ØªØ±ÙŠØ§Øª</option><option>Ø±ÙˆØ§ØªØ¨</option><option>Ø®Ø¯Ù…Ø§Øª</option><option>Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</option><option>ØªØ¬Ù‡ÙŠØ²Ø§Øª</option></select></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" class="f-input" id="eAmt" style="text-align:left;font-family:Cairo;font-weight:700"></div><div class="f-group"><label class="f-label">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input class="f-input" id="eInv" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div></div>
<button class="f-submit" onclick="addExpense()">Ø­ÙØ¸</button></div></div>

<div class="modal-bg" id="evalModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal"><div class="modal-hd"><h3>Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…</h3><button class="modal-x" onclick="hideModal('evalModal')">âœ•</button></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ù…ÙˆØ¸Ù</label><select class="f-select" id="evEmp"></select></div><div class="f-group"><label class="f-label">Ø§Ù„Ù…Ù‡Ù…Ø©</label><select class="f-select" id="evTask"></select></div></div>
<div class="f-row3"><div class="f-group" style="text-align:center"><label class="f-label">Ø§Ù„Ø³Ø±Ø¹Ø©</label><input type="number" class="f-input" id="evS" value="5" min="1" max="10" style="text-align:center;font-weight:800;font-family:Cairo;font-size:20px"></div><div class="f-group" style="text-align:center"><label class="f-label">Ø§Ù„Ø¬ÙˆØ¯Ø©</label><input type="number" class="f-input" id="evQ" value="5" min="1" max="10" style="text-align:center;font-weight:800;font-family:Cairo;font-size:20px"></div><div class="f-group" style="text-align:center"><label class="f-label">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label><input type="number" class="f-input" id="evP" value="5" min="1" max="10" style="text-align:center;font-weight:800;font-family:Cairo;font-size:20px"></div></div>
<button class="f-submit" onclick="addEval()">Ø­ÙØ¸</button></div></div>

<div class="modal-bg" id="userModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal"><div class="modal-hd"><h3 id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3><button class="modal-x" onclick="hideModal('userModal')">âœ•</button></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input class="f-input" id="uName"></div><div class="f-group"><label class="f-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input class="f-input" id="uUser" placeholder="Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ"></div></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input type="email" class="f-input" id="uEmail"></div><div class="f-group"><label class="f-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" class="f-input" id="uPass"></div></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„Ø¯ÙˆØ±</label><select class="f-select" id="uRole"><option value="super_admin">Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…</option><option value="project_manager">Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹</option><option value="team_lead">Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚</option><option value="employee" selected>Ù…ÙˆØ¸Ù</option><option value="viewer">Ù…Ø´Ø§Ù‡Ø¯</option></select></div><div class="f-group"><label class="f-label">Ø§Ù„Ù‚Ø³Ù…</label><select class="f-select" id="uDept"><option>ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option><option>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option><option>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option><option>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option><option>Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©</option></select></div></div>
<div class="f-row"><div class="f-group"><label class="f-label">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label><input class="f-input" id="uJobTitle"></div><div class="f-group"><label class="f-label">Ø§Ù„Ù‡Ø§ØªÙ</label><input class="f-input" id="uPhone"></div></div>
<input type="hidden" id="uEditId" value="">
<button class="f-submit" onclick="saveUser()">Ø­ÙØ¸</button></div></div>

<div class="modal-bg" id="profileModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal wide"><div class="modal-hd"><h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3><button class="modal-x" onclick="hideModal('profileModal')">âœ•</button></div><div id="profileContent"></div></div></div>
<div class="modal-bg" id="aiModal" onclick="if(event.target===this)hideModal(this.id)"><div class="modal wide"><div class="modal-hd"><h3>âœ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3><button class="modal-x" onclick="hideModal('aiModal')">âœ•</button></div><div id="aiContent"></div></div></div>

<script>
var SUPA_URL='https://ijbmlykvlbgextjisnry.supabase.co';
var SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqYm1seWt2bGJnZXh0amlzbnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTk5NDYsImV4cCI6MjA4Njk3NTk0Nn0.zPCzFh_QUQFOYC_8trxcAxwDQHyRZgZAb7eINN7hLpQ';
var H={'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=representation'};

async function dbGet(table){try{var r=await fetch(SUPA_URL+'/rest/v1/'+table+'?select=*&order=id.asc',{headers:H});return await r.json()}catch(e){return[]}}
async function dbInsert(table,data){try{var r=await fetch(SUPA_URL+'/rest/v1/'+table,{method:'POST',headers:H,body:JSON.stringify(data)});return await r.json()}catch(e){return null}}
async function dbUpdate(table,id,data){try{var r=await fetch(SUPA_URL+'/rest/v1/'+table+'?id=eq.'+id,{method:'PATCH',headers:H,body:JSON.stringify(data)});return await r.json()}catch(e){return null}}
async function dbDelete(table,id){try{await fetch(SUPA_URL+'/rest/v1/'+table+'?id=eq.'+id,{method:'DELETE',headers:H});return true}catch(e){return false}}

var users=[],projects=[],tasks=[],evals=[];
var SL={pending:'Ù…Ø¹Ù„Ù‚Ø©','in-progress':'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',completed:'Ù…ÙƒØªÙ…Ù„Ø©'};
var RL={super_admin:'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…',project_manager:'Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹',team_lead:'Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚',employee:'Ù…ÙˆØ¸Ù',viewer:'Ù…Ø´Ø§Ù‡Ø¯'};
var PRI={normal:'Ø¹Ø§Ø¯ÙŠØ©',high:'Ø¹Ø§Ù„ÙŠØ©',urgent:'Ø¹Ø§Ø¬Ù„Ø©'};
var depts=[{n:'Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',i:'ğŸ’¼'},{n:'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',i:'ğŸ‘¥'},{n:'ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',i:'ğŸ’»'},{n:'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',i:'âš™ï¸'},{n:'Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©',i:'âœ…'},{n:'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',i:'ğŸ›ï¸'}];
var curQF='all',curTV='table',calM,calY,gChart=null,isDark=true;
var chP=null,chT=null,chW=null,chPa=null,chPr=null,chDept=null,chTrend=null;
var repCharts={};
var _finIdx=0,finData=[],expenses_raw=[];
var activityLog=[];
var now=new Date();calM=now.getMonth();calY=now.getFullYear();

async function loadAllData(){
  var [u,p,t,ex,ev]=await Promise.all([dbGet('pms_users'),dbGet('pms_projects'),dbGet('pms_tasks'),dbGet('pms_expenses'),dbGet('pms_evaluations')]);
  users=u.map(function(x){return{id:x.id,u:x.username,p:x.password,n:x.fullname,r:x.role,email:x.email,dept:x.dept,jobTitle:x.job_title,phone:x.phone}});
  projects=p.map(function(x){return{id:x.id,name:x.name,mgr:x.manager,dept:x.dept,status:x.status,risk:x.risk,budget:parseFloat(x.budget)||0,prog:0}});
  tasks=t.map(function(x){return{id:x.id,name:x.name,proj:x.project,assign:x.assignee,w:x.weight||1,due:x.due_date||'',st:x.status,pri:x.priority||'normal'}});
  expenses_raw=ex;
  evals=ev.map(function(x){return{id:x.id,emp:x.employee,task:x.task,s:x.speed,q:x.quality,p:x.commitment}});
  finData=projects.map(function(pr){var exps=expenses_raw.filter(function(e){return e.project_name===pr.name}).map(function(e){return{id:e.id,type:e.type,amt:parseFloat(e.amount)||0,inv:e.invoice||'-'}});return{name:pr.name,budget:pr.budget,exps:exps}});
  // Build activity log
  activityLog=[];
  tasks.slice(-6).forEach(function(t){
    activityLog.push({color:'var(--blue)',title:'Ù…Ù‡Ù…Ø©: '+t.name,sub:(SL[t.st]||t.st)+' Â· '+t.proj,time:t.due||'â€“'});
  });
  projects.slice(-4).forEach(function(p){
    activityLog.push({color:'var(--green)',title:'Ù…Ø´Ø±ÙˆØ¹: '+p.name,sub:p.status+' Â· '+p.dept,time:''});
  });
}

function getAllEmps(){return users.map(function(u){var tc=tasks.filter(function(t){return t.assign===u.n}).length;return{id:u.id,name:u.n,email:u.email||'',role:u.jobTitle||RL[u.r],dept:u.dept||'',tasks:tc,avail:tc>0?'busy':'available'}})}
function calcProgress(){projects.forEach(function(p){var pt=tasks.filter(function(t){return t.proj===p.name});p.prog=pt.length?Math.round(pt.filter(function(t){return t.st==='completed'}).length/pt.length*100):0})}

async function doLogin(){
  var u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value;
  if(!u||!p){document.getElementById('lErr').textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';document.getElementById('lErr').classList.add('show');return}
  document.querySelector('.l-btn').textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  await loadAllData();
  var user=users.find(function(x){return x.u===u&&x.p===p});
  if(!user){document.getElementById('lErr').textContent='Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©';document.getElementById('lErr').classList.add('show');document.querySelector('.l-btn').textContent='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';return}
  document.getElementById('sbNm').textContent=user.n;document.getElementById('sbRl').textContent=RL[user.r];document.getElementById('sbAv').textContent=user.n[0];
  document.getElementById('loginPage').classList.add('hidden');document.getElementById('app').classList.add('active');
  initApp();
}
function doLogout(){document.getElementById('app').classList.remove('active');document.getElementById('loginPage').classList.remove('hidden');document.querySelector('.l-btn').textContent='ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'}
document.getElementById('lu').onkeydown=function(e){if(e.key==='Enter')doLogin()};
document.getElementById('lp').onkeydown=function(e){if(e.key==='Enter')doLogin()};
function toggleTheme(){isDark=!isDark;document.body.classList.toggle('light',!isDark);document.getElementById('themeBtn').textContent=isDark?'ğŸŒ™':'â˜€ï¸'}

function goTo(pg){
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active')});
  document.querySelectorAll('.sb-item').forEach(function(i){i.classList.remove('active')});
  document.getElementById('pg-'+pg).classList.add('active');
  var m={dashboard:0,calendar:1,projects:2,tasks:3,finance:4,hr:5,evaluations:6,reports:7,users:8,settings:9};
  var items=document.querySelectorAll('.sb-item');
  if(m[pg]!==undefined)items[m[pg]].classList.add('active');
  var t={dashboard:'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',calendar:'Ø§Ù„ØªÙ‚ÙˆÙŠÙ…',projects:'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',tasks:'Ø§Ù„Ù…Ù‡Ø§Ù…',finance:'Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',hr:'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',evaluations:'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª',reports:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',users:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'};
  document.getElementById('pgTitle').textContent=t[pg]||pg;
  document.getElementById('sidebar').classList.remove('open');
  if(pg==='dashboard')renderDash();
  if(pg==='projects')renderProjects();
  if(pg==='tasks')renderTasks();
  if(pg==='calendar')renderCal();
  if(pg==='finance')renderFinance();
  if(pg==='hr')renderHR();
  if(pg==='evaluations')renderEvals();
  if(pg==='users')renderUsers();
  if(pg==='reports')renderReports();
}

function initApp(){var d=new Date();var days=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];var months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];document.getElementById('todayDate').textContent=days[d.getDay()]+', '+d.getDate()+' '+months[d.getMonth()]+' '+d.getFullYear();renderUI()}
function renderUI(){calcProgress();renderDash();renderProjects();renderTasks();renderCal();renderFinance();renderHR();renderEvals();renderUsers()}

// ===================== DASHBOARD =====================
function destroyChart(c){if(c)c.destroy();return null}

function renderDash(){
  Chart.defaults.color='#94a3b8';
  Chart.defaults.font.family="'Tajawal','Cairo',sans-serif";
  var tc=tasks.filter(function(t){return t.st==='completed'}).length;
  var ip=tasks.filter(function(t){return t.st==='in-progress'}).length;
  var pn=tasks.filter(function(t){return t.st==='pending'}).length;
  var avgP=projects.length?Math.round(projects.reduce(function(s,p){return s+p.prog},0)/projects.length):0;
  var pip=projects.filter(function(p){return p.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}).length;
  var pap=projects.filter(function(p){return p.status==='Ù…Ø¹ØªÙ…Ø¯'}).length;
  var pdr=projects.filter(function(p){return p.status==='Ù…Ø³ÙˆØ¯Ø©'}).length;
  var totalBudget=projects.reduce(function(s,p){return s+p.budget},0);
  var totalExp=finData.reduce(function(s,f){return s+f.exps.reduce(function(a,e){return a+e.amt},0)},0);
  var overdue=tasks.filter(function(t){return t.due&&new Date(t.due)<new Date()&&t.st!=='completed'}).length;

  // KPI Cards
  var kpis=[
    {cl:'blue',ic:'ğŸ“',v:projects.length,lb:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',trend:{t:'up',v:pip+' Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}},
    {cl:'green',ic:'âœ…',v:tc,lb:'Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©',trend:{t:'up',v:tasks.length+' Ø¥Ø¬Ù…Ø§Ù„ÙŠ'}},
    {cl:'orange',ic:'ğŸ“ˆ',v:avgP+'%',lb:'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…',trend:{t:avgP>=50?'up':'down',v:avgP>=50?'Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯':'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©'}},
    {cl:'red',ic:'â±ï¸',v:overdue,lb:'Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©',trend:{t:overdue>0?'down':'up',v:overdue>0?'ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©':'Ù…Ù…ØªØ§Ø²'}},
    {cl:'purple',ic:'ğŸ’°',v:totalBudget.toLocaleString(),lb:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©',trend:{t:'neu',v:'Ø±.Ø¹'}},
    {cl:'cyan',ic:'ğŸ‘¥',v:users.length,lb:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†',trend:{t:'neu',v:getAllEmps().filter(function(e){return e.avail==='available'}).length+' Ù…ØªØ§Ø­'}},
  ];
  document.getElementById('dashKPI').innerHTML=kpis.map(function(k){
    return '<div class="kpi-card '+k.cl+'" onclick=""><div class="kpi-icon" style="background:rgba(56,189,248,.08)">'+k.ic+'</div><div class="kpi-value" style="color:var(--'+k.cl+')">'+k.v+'</div><div class="kpi-label">'+k.lb+'</div><div class="kpi-trend '+k.trend.t+'">'+( k.trend.t==='up'?'â†‘':k.trend.t==='down'?'â†“':'â†’')+' '+k.trend.v+'</div></div>';
  }).join('');

  // Charts
  chP=destroyChart(chP);
  chT=destroyChart(chT);
  chW=destroyChart(chW);
  chPa=destroyChart(chPa);
  chPr=destroyChart(chPr);
  chDept=destroyChart(chDept);
  chTrend=destroyChart(chTrend);

  chP=new Chart(document.getElementById('chProj'),{type:'doughnut',data:{labels:['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','Ù…Ø¹ØªÙ…Ø¯','Ù…Ø³ÙˆØ¯Ø©'],datasets:[{data:[pip,pap,pdr],backgroundColor:['#38bdf8','#34d399','#f59e0b'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14,font:{size:12}}}},cutout:'65%'}});

  chT=new Chart(document.getElementById('chTask2'),{type:'doughnut',data:{labels:['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','Ù…Ø¹Ù„Ù‚Ø©','Ù…ÙƒØªÙ…Ù„Ø©'],datasets:[{data:[ip,pn,tc],backgroundColor:['#38bdf8','#f59e0b','#34d399'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14,font:{size:12}}}},cutout:'65%'}});

  // Dept chart
  var deptNames=depts.map(function(d){return d.n});
  var deptCounts=deptNames.map(function(d){return users.filter(function(u){return u.dept===d}).length});
  chDept=new Chart(document.getElementById('chDept'),{type:'bar',data:{labels:deptNames.map(function(d){return d.substring(0,10)}),datasets:[{label:'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',data:deptCounts,backgroundColor:'rgba(167,139,250,.6)',borderRadius:6,hoverBackgroundColor:'rgba(167,139,250,.9)'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(56,189,248,.05)'}},x:{grid:{display:false}}}}});

  // Workload
  var wl={};tasks.forEach(function(t){wl[t.assign]=(wl[t.assign]||0)+1});var wn=Object.keys(wl),wd=Object.values(wl);
  chW=new Chart(document.getElementById('chWork'),{type:'bar',data:{labels:wn.length?wn:['Ù„Ø§ ØªÙˆØ¬Ø¯'],datasets:[{label:'Ø§Ù„Ù…Ù‡Ø§Ù…',data:wd.length?wd:[0],backgroundColor:'rgba(56,189,248,.6)',borderRadius:6,hoverBackgroundColor:'rgba(56,189,248,.9)'}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(56,189,248,.05)'}},y:{grid:{display:false}}}}});

  // Pareto (risk)
  var riskProj=projects.filter(function(p){return p.risk!=='Ù…Ù†Ø®ÙØ¶'});
  chPa=new Chart(document.getElementById('chPareto'),{type:'bar',data:{labels:riskProj.length?riskProj.map(function(p){return p.name.substring(0,12)}):['Ù„Ø§ ØªÙˆØ¬Ø¯'],datasets:[{label:'Ø§Ù„Ù…Ø®Ø§Ø·Ø±',data:riskProj.length?riskProj.map(function(p){return p.risk==='Ø¹Ø§Ù„ÙŠ'?3:1}):[0],backgroundColor:riskProj.map?riskProj.map(function(p){return p.risk==='Ø¹Ø§Ù„ÙŠ'?'rgba(239,68,68,.6)':'rgba(245,158,11,.6)'}):'rgba(245,158,11,.6)',borderRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{grid:{display:false}}}}});

  // Trend (simulated monthly)
  var months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ'];
  var completedPerMonth=[tc>5?tc-5:0,tc>3?tc-3:0,tc>1?tc-1:0,tc,tc];
  chTrend=new Chart(document.getElementById('chTrend'),{type:'line',data:{labels:months,datasets:[{label:'Ù…ÙƒØªÙ…Ù„Ø©',data:completedPerMonth,borderColor:'#34d399',backgroundColor:'rgba(52,211,153,.1)',tension:.4,fill:true,pointBackgroundColor:'#34d399',pointRadius:5}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(56,189,248,.05)'}},x:{grid:{display:false}}}}});

  // Progress bar chart
  var ep=document.getElementById('dashProgEmpty'),cv=document.getElementById('chProgress');
  if(projects.length){
    ep.style.display='none';cv.style.display='block';
    chPr=destroyChart(chPr);
    chPr=new Chart(cv,{type:'bar',data:{labels:projects.map(function(p){return p.name.substring(0,15)}),datasets:[{label:'%',data:projects.map(function(p){return p.prog}),backgroundColor:projects.map(function(p){return p.prog>=70?'rgba(52,211,153,.7)':p.prog>=40?'rgba(56,189,248,.6)':'rgba(245,158,11,.6)'}),borderRadius:6,hoverOffset:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100},x:{grid:{display:false}}}}});
  }else{ep.style.display='block';cv.style.display='none'}

  // Project progress list
  renderProjFilter('all');

  // Activity feed
  var af=document.getElementById('activityFeed');
  if(!activityLog.length){af.innerHTML='<div style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø¯ÙŠØ«</div>';return}
  af.innerHTML=activityLog.slice(0,8).map(function(a,i){return '<div class="activity-item"><div class="activity-dot" style="background:'+a.color+';margin-top:5px"></div><div class="activity-line"></div><div class="info"><div class="title">'+a.title+'</div><div class="sub">'+a.sub+'</div></div><div class="tl-time">'+a.time+'</div></div>'}).join('');

  // Risk table
  document.getElementById('riskBody').innerHTML=projects.length?projects.filter(function(p){return p.risk!=='Ù…Ù†Ø®ÙØ¶'}).map(function(p){var rc=p.risk==='Ø¹Ø§Ù„ÙŠ'?'red':'orange';return '<tr><td><b>'+p.name+'</b></td><td><div style="display:flex;align-items:center;gap:6px"><div class="prog-bar" style="width:80px"><div class="fill" style="width:'+p.prog+'%;background:var(--blue)"></div></div><span style="font-size:12px;font-family:Cairo">'+p.prog+'%</span></div></td><td><span class="badge blue">'+p.status+'</span></td><td><span class="badge '+rc+'">'+p.risk+'</span></td><td style="font-size:12px;color:var(--orange)">âš ï¸ Ù…ØªØ§Ø¨Ø¹Ø©</td></tr>'}).join(''):'<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';

  // Timeline
  var upcomingTasks=tasks.filter(function(t){return t.st!=='completed'}).sort(function(a,b){return a.due>b.due?1:-1}).slice(0,6);
  var tc2=document.getElementById('taskTimeline');
  if(!upcomingTasks.length){tc2.innerHTML='<div style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù‚Ø§Ø¯Ù…Ø©</div>';return}
  tc2.innerHTML=upcomingTasks.map(function(t){var isOverdue=t.due&&new Date(t.due)<new Date();var dotColor=t.st==='in-progress'?'var(--blue)':isOverdue?'var(--red)':'var(--orange)';return '<div class="tl-item"><div class="tl-dot" style="background:'+dotColor+'"></div><div class="tl-content"><div class="tl-title">'+t.name+'</div><div class="tl-sub">'+t.assign+' Â· '+t.proj+'</div></div><div class="tl-time">'+t.due+'</div></div>'}).join('');
}

function renderProjFilter(v){
  var pf=v||document.getElementById('progFilter').value;
  var filtered=projects.filter(function(p){return pf==='all'||p.status===pf});
  var el=document.getElementById('projProgressList');
  if(!filtered.length){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</div>';return}
  el.innerHTML=filtered.map(function(p){
    var rc=p.prog>=70?'var(--green)':p.prog>=40?'var(--blue)':'var(--orange)';
    var ptasks=tasks.filter(function(t){return t.proj===p.name});
    var done=ptasks.filter(function(t){return t.st==='completed'}).length;
    return '<div class="proj-progress-card"><div class="ppcard-top"><span class="ppcard-name">'+p.name+'</span><span class="ppcard-pct" style="color:'+rc+'">'+p.prog+'%</span></div><div class="prog-bar"><div class="fill" style="width:'+p.prog+'%;background:'+rc+'"></div></div><div class="ppcard-meta"><span>ğŸ¢ '+p.dept+'</span><span>âœ… '+done+'/'+ptasks.length+' Ù…Ù‡Ù…Ø©</span><span><span class="badge '+(p.risk==='Ø¹Ø§Ù„ÙŠ'?'red':p.risk==='Ù…ØªÙˆØ³Ø·'?'orange':'green')+'" style="padding:2px 8px;font-size:11px">'+p.risk+'</span></span></div></div>';
  }).join('');
}

function switchDashChart(view,group){
  document.querySelectorAll('#pg-dashboard .chart-tab').forEach(function(t){t.classList.remove('active')});
  var paneId='pane-'+group+'-'+view;
  document.querySelectorAll('[id^="pane-'+group+'-"]').forEach(function(p){p.classList.remove('active')});
  var target=document.getElementById(paneId);
  if(target){target.classList.add('active');event.target.classList.add('active')}
}

// ===================== REPORTS =====================
var currentReport='overview';
var repChartInstances={};

function switchReport(r){
  currentReport=r;
  document.querySelectorAll('.r-tab').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.report-section').forEach(function(s){s.classList.remove('active')});
  event.target.classList.add('active');
  var sec=document.getElementById('rep-'+r);
  if(sec)sec.classList.add('active');
  renderReportSection(r);
}

function renderReports(){
  renderReportSection('overview');
}

function destroyRepChart(key){
  if(repChartInstances[key]){repChartInstances[key].destroy();delete repChartInstances[key];}
}

function renderReportSection(r){
  if(r==='overview')renderRepOverview();
  if(r==='projects')renderRepProjects();
  if(r==='tasks')renderRepTasks();
  if(r==='financial')renderRepFinancial();
  if(r==='performance')renderRepPerformance();
}

function renderRepOverview(){
  var tc=tasks.filter(function(t){return t.st==='completed'}).length;
  var ip=tasks.filter(function(t){return t.st==='in-progress'}).length;
  var pn=tasks.filter(function(t){return t.st==='pending'}).length;
  var totalB=projects.reduce(function(s,p){return s+p.budget},0);
  var totalE=finData.reduce(function(s,f){return s+f.exps.reduce(function(a,e){return a+e.amt},0)},0);
  var overdue=tasks.filter(function(t){return t.due&&new Date(t.due)<new Date()&&t.st!=='completed'}).length;
  var rate=tasks.length?Math.round(tc/tasks.length*100):0;
  
  document.getElementById('repKPIs').innerHTML=[
    ['blue','ğŸ“',projects.length,'Ù…Ø´Ø§Ø±ÙŠØ¹'],
    ['green','âœ…',tc,'Ù…ÙƒØªÙ…Ù„Ø©'],
    ['orange','ğŸ“ˆ',rate+'%','Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²'],
    ['red','â±ï¸',overdue,'Ù…ØªØ£Ø®Ø±Ø©'],
    ['purple','ğŸ’°',totalB.toLocaleString(),'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø±.Ø¹)'],
    ['cyan','ğŸ’¸',totalE.toLocaleString(),'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'],
  ].map(function(x){return '<div class="metric-highlight"><div class="mh-icon">'+x[1]+'</div><div class="mh-value" style="color:var(--'+x[0]+')">'+x[2]+'</div><div class="mh-label">'+x[3]+'</div></div>'}).join('');

  destroyRepChart('repProjChart');destroyRepChart('repTaskChart');
  var pip=projects.filter(function(p){return p.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}).length;
  var pap=projects.filter(function(p){return p.status==='Ù…Ø¹ØªÙ…Ø¯'}).length;
  var pdr=projects.filter(function(p){return p.status==='Ù…Ø³ÙˆØ¯Ø©'}).length;
  repChartInstances['repProjChart']=new Chart(document.getElementById('repProjChart'),{type:'pie',data:{labels:['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','Ù…Ø¹ØªÙ…Ø¯','Ù…Ø³ÙˆØ¯Ø©'],datasets:[{data:[pip,pap,pdr],backgroundColor:['#38bdf8','#34d399','#f59e0b'],borderWidth:2,borderColor:'var(--card)'}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14,font:{size:12}}}}}});
  
  var months=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ'];
  var taskData=months.map(function(_,i){return Math.max(0,tc-Math.round(tc*(5-i)/10)+(i>0?Math.floor(Math.random()*2):0))});
  repChartInstances['repTaskChart']=new Chart(document.getElementById('repTaskChart'),{type:'line',data:{labels:months,datasets:[{label:'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©',data:taskData,borderColor:'#34d399',backgroundColor:'rgba(52,211,153,.1)',tension:.4,fill:true,pointRadius:5,pointBackgroundColor:'#34d399'},{label:'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',data:months.map(function(){return Math.max(1,Math.floor(tasks.length/6))}),borderColor:'#38bdf8',backgroundColor:'rgba(56,189,248,.1)',tension:.4,fill:true,pointRadius:5,pointBackgroundColor:'#38bdf8'}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14,font:{size:12}}}},scales:{y:{beginAtZero:true,grid:{color:'rgba(56,189,248,.05)'}},x:{grid:{display:false}}}}});

  // Top performers
  var perfMap={};
  evals.forEach(function(e){if(!perfMap[e.emp])perfMap[e.emp]={c:0,t:0};perfMap[e.emp].c++;perfMap[e.emp].t+=e.s+e.q+e.p});
  var performers=Object.entries(perfMap).map(function(x){return{name:x[0],avg:x[1].c?x[1].t/(x[1].c*3):0,count:x[1].c}}).sort(function(a,b){return b.avg-a.avg});
  var rankNums=['gold','silver','bronze'];
  document.getElementById('topPerformers').innerHTML=performers.length?performers.slice(0,5).map(function(p,i){return '<li class="rank-item"><div class="rank-num '+(rankNums[i]||'')+'">'+( i+1)+'</div><div class="rank-info"><div class="rank-name">'+p.name+'</div><div class="rank-sub">'+p.count+' ØªÙ‚ÙŠÙŠÙ…</div></div><div class="rank-score" style="color:var(--'+(p.avg>=8?'green':p.avg>=6?'blue':'orange')+')">'+p.avg.toFixed(1)+'/10</div></li>'}).join(''):'<li style="padding:20px;text-align:center;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</li>';

  // Performance summary
  var avgProg=projects.length?Math.round(projects.reduce(function(s,p){return s+p.prog},0)/projects.length):0;
  document.getElementById('perfSummary').innerHTML='<div class="summary-box"><h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„</h4><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: <b style="color:var(--blue)">'+projects.length+'</b> Â· Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: <b style="color:var(--orange)">'+pip+'</b><br>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…: <b style="color:var(--blue)">'+tasks.length+'</b> Â· Ù…ÙƒØªÙ…Ù„Ø©: <b style="color:var(--green)">'+tc+'</b><br>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…: <b style="color:var(--cyan)">'+avgProg+'%</b> Â· Ù…ØªØ£Ø®Ø±Ø©: <b style="color:var(--red)">'+overdue+'</b><br>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©: <b style="color:var(--purple)">'+totalB.toLocaleString()+' Ø±.Ø¹</b><br>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <b style="color:var(--orange)">'+totalE.toLocaleString()+' Ø±.Ø¹</b></p></div><div style="margin-top:12px"><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span style="color:var(--t2)">Ù…Ø¹Ø¯Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ø§Ù…</span><b style="font-family:Cairo">'+rate+'%</b></div><div class="prog-bar" style="height:10px"><div class="fill" style="width:'+rate+'%;background:linear-gradient(90deg,#38bdf8,#34d399)"></div></div></div>';
}

function renderRepProjects(){
  var metrics=[['blue','ğŸ“',projects.length,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹'],['green','âœ…',projects.filter(function(p){return p.status==='Ù…Ø¹ØªÙ…Ø¯'}).length,'Ù…Ø¹ØªÙ…Ø¯'],['orange','ğŸ”„',projects.filter(function(p){return p.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}).length,'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'],['red','âš ï¸',projects.filter(function(p){return p.risk==='Ø¹Ø§Ù„ÙŠ'}).length,'Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©'],['purple','ğŸ“Š',projects.length?Math.round(projects.reduce(function(s,p){return s+p.prog},0)/projects.length):0+'%','Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…'],['cyan','ğŸ’°',projects.reduce(function(s,p){return s+p.budget},0).toLocaleString(),'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©']];
  document.getElementById('repProjMetrics').innerHTML=metrics.map(function(x){return '<div class="metric-highlight"><div class="mh-icon">'+x[1]+'</div><div class="mh-value" style="color:var(--'+x[0]+')">'+x[2]+'</div><div class="mh-label">'+x[3]+'</div></div>'}).join('');

  // Project detail table
  document.getElementById('repProjBody').innerHTML=projects.length?projects.map(function(p){
    var ptasks=tasks.filter(function(t){return t.proj===p.name});
    var done=ptasks.filter(function(t){return t.st==='completed'}).length;
    var rate=ptasks.length?Math.round(done/ptasks.length*100):0;
    var sc=p.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'?'blue':p.status==='Ù…Ø¹ØªÙ…Ø¯'?'green':'orange';
    var rc=p.risk==='Ø¹Ø§Ù„ÙŠ'?'red':p.risk==='Ù…ØªÙˆØ³Ø·'?'orange':'green';
    return '<tr><td><b>'+p.name+'</b></td><td>'+p.mgr+'</td><td><span class="badge '+sc+'">'+p.status+'</span></td><td><span class="badge '+rc+'">'+p.risk+'</span></td><td><div style="display:flex;align-items:center;gap:6px"><div class="prog-bar" style="width:70px"><div class="fill" style="width:'+p.prog+'%;background:var(--blue)"></div></div><span style="font-size:12px;font-family:Cairo">'+p.prog+'%</span></div></td><td style="font-family:Cairo;font-weight:700">'+ptasks.length+'</td><td style="font-family:Cairo;font-weight:700;color:var(--green)">'+done+'</td><td><span class="badge '+(rate>=70?'green':rate>=40?'blue':'orange')+'">'+rate+'%</span></td></tr>';
  }).join(''):'<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</td></tr>';

  destroyRepChart('repProjProgress');destroyRepChart('repRiskChart');
  repChartInstances['repProjProgress']=new Chart(document.getElementById('repProjProgress'),{type:'bar',data:{labels:projects.map(function(p){return p.name.substring(0,12)}),datasets:[{label:'Ø§Ù„ØªÙ‚Ø¯Ù… %',data:projects.map(function(p){return p.prog}),backgroundColor:projects.map(function(p){return p.prog>=70?'rgba(52,211,153,.7)':p.prog>=40?'rgba(56,189,248,.6)':'rgba(245,158,11,.6)'}),borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100,grid:{color:'rgba(56,189,248,.05)'}},x:{grid:{display:false}}}}});
  var rLow=projects.filter(function(p){return p.risk==='Ù…Ù†Ø®ÙØ¶'}).length;
  var rMed=projects.filter(function(p){return p.risk==='Ù…ØªÙˆØ³Ø·'}).length;
  var rHi=projects.filter(function(p){return p.risk==='Ø¹Ø§Ù„ÙŠ'}).length;
  repChartInstances['repRiskChart']=new Chart(document.getElementById('repRiskChart'),{type:'doughnut',data:{labels:['Ù…Ù†Ø®ÙØ¶','Ù…ØªÙˆØ³Ø·','Ø¹Ø§Ù„ÙŠ'],datasets:[{data:[rLow,rMed,rHi],backgroundColor:['rgba(52,211,153,.7)','rgba(245,158,11,.7)','rgba(239,68,68,.7)'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14}}},cutout:'60%'}});
}

function renderRepTasks(){
  var tc=tasks.filter(function(t){return t.st==='completed'}).length;
  var ip=tasks.filter(function(t){return t.st==='in-progress'}).length;
  var pn=tasks.filter(function(t){return t.st==='pending'}).length;
  var overdue=tasks.filter(function(t){return t.due&&new Date(t.due)<new Date()&&t.st!=='completed'}).length;
  var highP=tasks.filter(function(t){return t.pri==='high'||t.pri==='urgent'}).length;
  var rate=tasks.length?Math.round(tc/tasks.length*100):0;
  document.getElementById('repTaskMetrics').innerHTML=[['blue','ğŸ“‹',tasks.length,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…'],['green','âœ…',tc,'Ù…ÙƒØªÙ…Ù„Ø©'],['orange','ğŸ”„',ip,'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'],['red','â±ï¸',overdue,'Ù…ØªØ£Ø®Ø±Ø©'],['purple','â­',highP,'Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©'],['cyan','ğŸ“ˆ',rate+'%','Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²']].map(function(x){return '<div class="metric-highlight"><div class="mh-icon">'+x[1]+'</div><div class="mh-value" style="color:var(--'+x[0]+')">'+x[2]+'</div><div class="mh-label">'+x[3]+'</div></div>'}).join('');
  
  destroyRepChart('repTaskStatus');destroyRepChart('repTaskAssign');
  repChartInstances['repTaskStatus']=new Chart(document.getElementById('repTaskStatus'),{type:'doughnut',data:{labels:['Ù…ÙƒØªÙ…Ù„Ø©','Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','Ù…Ø¹Ù„Ù‚Ø©'],datasets:[{data:[tc,ip,pn],backgroundColor:['#34d399','#38bdf8','#f59e0b'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14}}},cutout:'65%'}});
  
  var wl={};tasks.forEach(function(t){wl[t.assign]=(wl[t.assign]||0)+1});
  var wn=Object.keys(wl),wd=Object.values(wl);
  repChartInstances['repTaskAssign']=new Chart(document.getElementById('repTaskAssign'),{type:'bar',data:{labels:wn.length?wn:['Ù„Ø§ ØªÙˆØ¬Ø¯'],datasets:[{label:'Ø§Ù„Ù…Ù‡Ø§Ù…',data:wd.length?wd:[0],backgroundColor:'rgba(56,189,248,.6)',borderRadius:6,hoverBackgroundColor:'rgba(56,189,248,.9)'}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,grid:{color:'rgba(56,189,248,.05)'}},y:{grid:{display:false}}}}});
  renderRepTaskTable();
}

function renderRepTaskTable(){
  var fv=document.getElementById('repTaskFilter')?document.getElementById('repTaskFilter').value:'all';
  var ft=tasks.filter(function(t){return fv==='all'||t.st===fv});
  var sc=function(s){return s==='completed'?'green':s==='in-progress'?'blue':'orange'};
  var pc=function(p){return p==='urgent'?'red':p==='high'?'orange':'gray'};
  document.getElementById('repTaskTable').innerHTML=ft.length?ft.map(function(t){return '<tr><td><b>'+t.name+'</b></td><td><span class="badge blue">'+t.proj+'</span></td><td>'+t.assign+'</td><td style="font-size:13px;font-family:Cairo">'+t.due+'</td><td><span class="badge '+sc(t.st)+'">'+(SL[t.st]||t.st)+'</span></td><td><span class="badge '+pc(t.pri)+'">'+(PRI[t.pri]||t.pri)+'</span></td></tr>'}).join(''):'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</td></tr>';
}

function renderRepFinancial(){
  var totalB=projects.reduce(function(s,p){return s+p.budget},0);
  var totalE=finData.reduce(function(s,f){return s+f.exps.reduce(function(a,e){return a+e.amt},0)},0);
  var rem=totalB-totalE;
  var rate=totalB>0?Math.round(totalE/totalB*100):0;
  var overBudget=finData.filter(function(f){var e=f.exps.reduce(function(s,x){return s+x.amt},0);return e>f.budget}).length;
  document.getElementById('repFinMetrics').innerHTML=[['blue','ğŸ’°',totalB.toLocaleString(),'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©'],['red','ğŸ’¸',totalE.toLocaleString(),'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª'],['green','ğŸ’µ',rem.toLocaleString(),'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'],['orange','ğŸ“Š',rate+'%','Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ'],['red','âš ï¸',overBudget,'ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©'],['purple','ğŸ“',finData.length,'Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø§Ù„ÙŠØ©']].map(function(x){return '<div class="metric-highlight"><div class="mh-icon">'+x[1]+'</div><div class="mh-value" style="color:var(--'+x[0]+')">'+x[2]+'</div><div class="mh-label">'+x[3]+'</div></div>'}).join('');
  
  destroyRepChart('repFinChart');destroyRepChart('repExpChart');
  repChartInstances['repFinChart']=new Chart(document.getElementById('repFinChart'),{type:'bar',data:{labels:finData.map(function(f){return f.name.substring(0,12)}),datasets:[{label:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',data:finData.map(function(f){return f.budget}),backgroundColor:'rgba(56,189,248,.5)',borderRadius:5},{label:'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',data:finData.map(function(f){return f.exps.reduce(function(s,e){return s+e.amt},0)}),backgroundColor:'rgba(239,68,68,.5)',borderRadius:5}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:14}}},scales:{y:{beginAtZero:true,grid:{color:'rgba(56,189,248,.05)'}},x:{grid:{display:false}}}}});

  // Expense by type
  var expTypes={};
  finData.forEach(function(f){f.exps.forEach(function(e){expTypes[e.type]=(expTypes[e.type]||0)+e.amt})});
  var etKeys=Object.keys(expTypes),etVals=Object.values(expTypes);
  repChartInstances['repExpChart']=new Chart(document.getElementById('repExpChart'),{type:'doughnut',data:{labels:etKeys.length?etKeys:['Ù„Ø§ ØªÙˆØ¬Ø¯'],datasets:[{data:etVals.length?etVals:[1],backgroundColor:['#38bdf8','#34d399','#f59e0b','#ef4444','#a78bfa'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:12}}},cutout:'55%'}});

  // Financial table
  document.getElementById('repFinTable').innerHTML=finData.length?finData.map(function(f){
    var te=f.exps.reduce(function(s,e){return s+e.amt},0);var rem2=f.budget-te;var pct=f.budget>0?Math.round(te/f.budget*100):0;var sts=pct>90?'red':pct>70?'orange':'green';
    return '<tr><td><b>'+f.name+'</b></td><td style="font-family:Cairo;font-weight:700;color:var(--blue)">'+f.budget+'</td><td style="font-family:Cairo;font-weight:700;color:var(--red)">'+te+'</td><td style="font-family:Cairo;font-weight:700;color:var(--green)">'+rem2+'</td><td><div style="display:flex;align-items:center;gap:6px"><div class="prog-bar" style="width:80px"><div class="fill" style="width:'+pct+'%;background:var(--'+sts+')"></div></div><span style="font-size:12px;font-family:Cairo">'+pct+'%</span></div></td><td><span class="badge '+(pct>90?'red':pct>70?'orange':'green')+'">'+(pct>90?'ØªØ¬Ø§ÙˆØ²':pct>70?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ')+'</span></td></tr>';
  }).join(''):'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§Ù„ÙŠØ©</td></tr>';
}

function renderRepPerformance(){
  var avgScore=evals.length?(evals.reduce(function(s,e){return s+e.s+e.q+e.p},0)/(evals.length*3)).toFixed(1):0;
  var avgSpeed=evals.length?(evals.reduce(function(s,e){return s+e.s},0)/evals.length).toFixed(1):0;
  var avgQuality=evals.length?(evals.reduce(function(s,e){return s+e.q},0)/evals.length).toFixed(1):0;
  var avgCommit=evals.length?(evals.reduce(function(s,e){return s+e.p},0)/evals.length).toFixed(1):0;
  var excellent=evals.filter(function(e){return (e.s+e.q+e.p)/3>=8}).length;
  document.getElementById('repPerfMetrics').innerHTML=[['blue','ğŸ“‹',evals.length,'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª'],['green','â­',avgScore,'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡'],['orange','âš¡',avgSpeed,'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©'],['purple','ğŸ¯',avgQuality,'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©'],['cyan','ğŸ¤',avgCommit,'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'],['green','ğŸ†',excellent,'Ù…Ù…ØªØ§Ø²']].map(function(x){return '<div class="metric-highlight"><div class="mh-icon">'+x[1]+'</div><div class="mh-value" style="color:var(--'+x[0]+')">'+x[2]+'</div><div class="mh-label">'+x[3]+'</div></div>'}).join('');

  // Rankings
  var perfMap={};
  evals.forEach(function(e){if(!perfMap[e.emp])perfMap[e.emp]={c:0,s:0,q:0,p:0};perfMap[e.emp].c++;perfMap[e.emp].s+=e.s;perfMap[e.emp].q+=e.q;perfMap[e.emp].p+=e.p});
  var ranked=Object.entries(perfMap).map(function(x){return{name:x[0],avg:(x[1].s+x[1].q+x[1].p)/(x[1].c*3),speed:x[1].s/x[1].c,quality:x[1].q/x[1].c,commit:x[1].p/x[1].c,count:x[1].c}}).sort(function(a,b){return b.avg-a.avg});
  var medals=['gold','silver','bronze'];
  document.getElementById('repRankList').innerHTML=ranked.length?ranked.slice(0,6).map(function(p,i){return '<li class="rank-item"><div class="rank-num '+(medals[i]||'')+'">'+( i+1)+'</div><div class="rank-info"><div class="rank-name">'+p.name+'</div><div class="rank-sub">'+p.count+' ØªÙ‚ÙŠÙŠÙ… Â· Ø³Ø±Ø¹Ø© '+p.speed.toFixed(1)+' Â· Ø¬ÙˆØ¯Ø© '+p.quality.toFixed(1)+'</div></div><div class="rank-score" style="color:var(--'+(p.avg>=8?'green':p.avg>=6?'blue':'orange')+')">'+p.avg.toFixed(1)+'</div></li>'}).join(''):'<li style="padding:20px;text-align:center;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</li>';

  destroyRepChart('repPerfChart');
  repChartInstances['repPerfChart']=new Chart(document.getElementById('repPerfChart'),{type:'radar',data:{labels:['Ø§Ù„Ø³Ø±Ø¹Ø©','Ø§Ù„Ø¬ÙˆØ¯Ø©','Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'],datasets:ranked.slice(0,3).map(function(p,i){var clrs=['#38bdf8','#34d399','#a78bfa'];return{label:p.name,data:[p.speed,p.quality,p.commit],borderColor:clrs[i],backgroundColor:clrs[i].replace('#','rgba(').replace('38bdf8','56,189,248,.1').replace('34d399','52,211,153,.1').replace('a78bfa','167,139,250,.1'),pointBackgroundColor:clrs[i],pointRadius:5}})},options:{responsive:true,scales:{r:{min:0,max:10,ticks:{stepSize:2,font:{size:10}},grid:{color:'rgba(56,189,248,.1)'},pointLabels:{font:{size:13,family:'Tajawal'}}}},plugins:{legend:{position:'bottom',labels:{padding:14,font:{size:12}}}}}});

  // Performance table
  document.getElementById('repPerfTable').innerHTML=ranked.length?ranked.map(function(p){var grade=p.avg>=9?'Ù…Ù…ØªØ§Ø²':p.avg>=7?'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹':p.avg>=5?'Ø¬ÙŠØ¯':'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';var gc=p.avg>=9?'green':p.avg>=7?'blue':p.avg>=5?'orange':'red';return '<tr><td style="font-weight:700;color:var(--blue)">'+p.name+'</td><td style="font-family:Cairo;text-align:center">'+p.count+'</td><td>'+p.speed.toFixed(1)+'/10</td><td>'+p.quality.toFixed(1)+'/10</td><td>'+p.commit.toFixed(1)+'/10</td><td style="font-family:Cairo;font-weight:800">'+(p.avg*3).toFixed(1)+'/30</td><td><span class="badge '+gc+'">'+grade+'</span></td></tr>'}).join(''):'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</td></tr>';
}

function printReport(){window.print();toast('Ø¬Ø§Ø±Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...')}

// ===================== PROJECTS =====================
function renderProjects(){var sf=document.getElementById('projStat')?document.getElementById('projStat').value:'all';var s=(document.getElementById('projSearch')?document.getElementById('projSearch').value:'').toLowerCase();var f=projects.filter(function(p){return(sf==='all'||p.status===sf)&&(!s||p.name.includes(s))});var sc=function(s){return s==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'?'blue':s==='Ù…Ø¹ØªÙ…Ø¯'?'green':s==='Ù…Ø³ÙˆØ¯Ø©'?'orange':'red'};var rc=function(r){return r==='Ø¹Ø§Ù„ÙŠ'?'red':r==='Ù…ØªÙˆØ³Ø·'?'orange':'green'};document.getElementById('projBody').innerHTML=f.length?f.map(function(p){return '<tr><td><b>'+p.name+'</b></td><td>'+p.mgr+'</td><td><span class="badge blue">'+p.dept+'</span></td><td><span class="badge '+sc(p.status)+'">'+p.status+'</span></td><td><span class="badge '+rc(p.risk)+'">'+p.risk+'</span></td><td><div style="display:flex;align-items:center;gap:6px"><div class="prog-bar" style="width:80px"><div class="fill" style="width:'+p.prog+'%;background:var(--blue)"></div></div><span style="font-size:12px;font-family:Cairo">'+p.prog+'%</span></div></td><td><button class="act-btn" style="color:var(--orange)" onclick="editProject('+p.id+')">âœï¸</button> <button class="act-btn del" onclick="delProject('+p.id+')">ğŸ—‘ï¸</button></td></tr>'}).join(''):'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</td></tr>'}
async function addProject(){var n=document.getElementById('pName').value;if(!n)return;var b=parseFloat(document.getElementById('pBudget').value)||0;var res=await dbInsert('pms_projects',{name:n,manager:document.getElementById('pMgr').value,dept:document.getElementById('pDept').value,status:document.getElementById('pStat').value,risk:document.getElementById('pRisk').value,budget:b});if(res&&res[0]){projects.push({id:res[0].id,name:n,mgr:res[0].manager,dept:res[0].dept,status:res[0].status,risk:res[0].risk,budget:b,prog:0});finData.push({name:n,budget:b,exps:[]})}hideModal('projModal');renderUI();toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');document.getElementById('pName').value='';document.getElementById('pBudget').value=''}
async function delProject(id){var p=projects.find(function(x){return x.id===id});if(!p||!confirm('Ø­Ø°Ù '+p.name+'ØŸ'))return;await dbDelete('pms_projects',id);projects=projects.filter(function(x){return x.id!==id});finData=finData.filter(function(x){return x.name!==p.name});renderUI();renderFinance();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}
function editProject(id){var p=projects.find(function(x){return x.id===id});if(!p)return;showModal('projModal');document.getElementById('pName').value=p.name;document.getElementById('pDept').value=p.dept;document.getElementById('pStat').value=p.status;document.getElementById('pRisk').value=p.risk;document.getElementById('pBudget').value=p.budget||'';setTimeout(function(){document.getElementById('pMgr').value=p.mgr},50);document.querySelector('#projModal .f-submit').onclick=async function(){var n=document.getElementById('pName').value;if(!n)return;var old=p.name;var b=parseFloat(document.getElementById('pBudget').value)||p.budget;await dbUpdate('pms_projects',id,{name:n,manager:document.getElementById('pMgr').value,dept:document.getElementById('pDept').value,status:document.getElementById('pStat').value,risk:document.getElementById('pRisk').value,budget:b});p.name=n;p.mgr=document.getElementById('pMgr').value;p.dept=document.getElementById('pDept').value;p.status=document.getElementById('pStat').value;p.risk=document.getElementById('pRisk').value;p.budget=b;var fd=finData.find(function(f){return f.name===old});if(fd){fd.name=n;fd.budget=b}hideModal('projModal');document.querySelector('#projModal .f-submit').onclick=function(){addProject()};renderUI();renderFinance();toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…')}}

// ===================== TASKS =====================
function getFilteredTasks(){var s=(document.getElementById('taskSearch')?document.getElementById('taskSearch').value:'').toLowerCase();var sf=document.getElementById('taskStatF')?document.getElementById('taskStatF').value:'all';return tasks.filter(function(t){if(s&&t.name.toLowerCase().indexOf(s)===-1&&t.assign.indexOf(s)===-1)return false;if(sf!=='all'&&t.st!==sf)return false;if(curQF==='overdue'){var d=new Date(t.due);if(d>=new Date()||t.st==='completed')return false}if(curQF==='priority'&&t.pri!=='high'&&t.pri!=='urgent')return false;return true})}
function renderTasks(){var f=getFilteredTasks();if(curTV==='table'){document.getElementById('taskBody').innerHTML=f.length?f.map(function(t){var sc=t.st==='completed'?'green':t.st==='in-progress'?'blue':'orange';return '<tr><td><b>'+t.name+'</b><br><span style="font-size:12px;color:var(--t3)">'+t.proj+'</span></td><td><span class="badge blue">'+t.assign+'</span></td><td style="font-weight:700;font-family:Cairo">'+t.w+'</td><td style="font-size:13px;font-family:Cairo">ğŸ“… '+t.due+'</td><td><span class="badge '+sc+'">'+(SL[t.st]||t.st)+'</span></td><td><button class="act-btn" style="color:var(--orange)" onclick="editTask('+t.id+')">âœï¸</button> <button class="act-btn del" onclick="delTask('+t.id+')">ğŸ—‘ï¸</button></td></tr>'}).join(''):'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</td></tr>'}else{var cols={pending:[],'in-progress':[],completed:[]};f.forEach(function(t){if(cols[t.st])cols[t.st].push(t)});document.getElementById('boardCols').innerHTML=[{k:'pending',l:'Ù…Ø¹Ù„Ù‚Ø©'},{k:'in-progress',l:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'},{k:'completed',l:'Ù…ÙƒØªÙ…Ù„Ø©'}].map(function(c){return '<div class="board-col"><div class="board-col-hd">'+c.l+'<span class="cnt">'+cols[c.k].length+'</span></div><div class="board-col-bd">'+cols[c.k].map(function(t){return '<div class="b-card"><div class="b-card-t">'+t.name+'</div><div class="b-card-m"><span style="color:var(--blue)">'+t.assign+'</span><span>'+t.due+'</span></div></div>'}).join('')+'</div></div>'}).join('')}}
function switchTV(v){curTV=v;document.getElementById('taskTV').style.display=v==='table'?'block':'none';document.getElementById('taskBV').style.display=v==='board'?'block':'none';document.getElementById('tv-table').classList.toggle('active',v==='table');document.getElementById('tv-board').classList.toggle('active',v==='board');renderTasks()}
function taskQF(t){curQF=t;['all','overdue','priority'].forEach(function(x){document.getElementById('qf-'+x).classList.toggle('active',x===t)});renderTasks()}
async function addTask(){var n=document.getElementById('tName').value;if(!n)return;var d=document.getElementById('tDate').value;var res=await dbInsert('pms_tasks',{name:n,project:document.getElementById('tProj').value,assignee:document.getElementById('tAssign').value,due_date:d,status:document.getElementById('tStat').value,priority:document.getElementById('tPri').value});if(res&&res[0])tasks.push({id:res[0].id,name:n,proj:res[0].project,assign:res[0].assignee,w:1,due:d,st:res[0].status,pri:res[0].priority});hideModal('taskModal');renderUI();toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');document.getElementById('tName').value=''}
async function delTask(id){if(!confirm('Ø­Ø°ÙØŸ'))return;await dbDelete('pms_tasks',id);tasks=tasks.filter(function(x){return x.id!==id});renderUI();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}
function editTask(id){var t=tasks.find(function(x){return x.id===id});if(!t)return;showModal('taskModal');document.getElementById('tName').value=t.name;document.getElementById('tDate').value=t.due;document.getElementById('tStat').value=t.st;document.getElementById('tPri').value=t.pri||'normal';setTimeout(function(){document.getElementById('tProj').value=t.proj;document.getElementById('tAssign').value=t.assign},50);document.querySelector('#taskModal .f-submit').onclick=async function(){var n=document.getElementById('tName').value;if(!n)return;await dbUpdate('pms_tasks',id,{name:n,project:document.getElementById('tProj').value,assignee:document.getElementById('tAssign').value,due_date:document.getElementById('tDate').value,status:document.getElementById('tStat').value,priority:document.getElementById('tPri').value});t.name=n;t.proj=document.getElementById('tProj').value;t.assign=document.getElementById('tAssign').value;t.due=document.getElementById('tDate').value;t.st=document.getElementById('tStat').value;t.pri=document.getElementById('tPri').value;hideModal('taskModal');document.querySelector('#taskModal .f-submit').onclick=function(){addTask()};renderUI();toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…')}}

// ===================== CALENDAR =====================
function renderCal(){var ms=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];document.getElementById('calTitle').textContent=ms[calM]+' '+calY;var cp=document.getElementById('calProj');var cv=cp.value;cp.innerHTML='<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</option>'+projects.map(function(p){return '<option'+(p.name===cv?' selected':'')+'>'+p.name+'</option>'}).join('');var pf=cp.value;var first=new Date(calY,calM,1).getDay();var start=(first+1)%7;var days=new Date(calY,calM+1,0).getDate();var today=new Date();var html='';for(var i=0;i<start;i++)html+='<div></div>';for(var d=1;d<=days;d++){var ds=calY+'-'+String(calM+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');var isT=(d===today.getDate()&&calM===today.getMonth()&&calY===today.getFullYear());var ev=tasks.filter(function(t){return t.due===ds&&(pf==='all'||t.proj===pf)});html+='<div style="min-height:52px;padding:4px;border:1px solid var(--bdr);border-radius:6px;'+(isT?'background:rgba(56,189,248,.08);border-color:var(--blue)':'')+'"><div style="font-size:13px;font-weight:'+(isT?'800':'600')+';color:'+(isT?'var(--blue)':'var(--t2)')+'">'+d+'</div>';ev.forEach(function(e){var c=e.st==='completed'?'green':e.st==='in-progress'?'blue':'orange';html+='<div style="font-size:10px;padding:2px 4px;border-radius:3px;margin-top:1px;background:rgba('+(c==='blue'?'56,189,248':c==='green'?'52,211,153':'245,158,11')+',.15);color:var(--'+c+');white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+e.name+'</div>'});html+='</div>'}document.getElementById('calGrid').innerHTML=html}
function calNav(dir){calM+=dir;if(calM>11){calM=0;calY++}if(calM<0){calM=11;calY--}renderCal()}

// ===================== FINANCE =====================
function renderFinance(forceIdx){var sel=document.getElementById('finProj');if(forceIdx!==undefined)_finIdx=forceIdx;sel.innerHTML=finData.length?finData.map(function(f,i){return '<option value="'+i+'"'+(i===_finIdx?' selected':'')+'>'+f.name+'</option>'}).join(''):'<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</option>';if(!finData.length){document.getElementById('finProjName').textContent='';document.getElementById('finStats').innerHTML='<div style="text-align:center;padding:20px;color:var(--t3)">Ø£Ø¶Ù Ù…Ø´Ø§Ø±ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹</div>';document.getElementById('expBody').innerHTML='';document.getElementById('finSummary').innerHTML='';document.getElementById('gaugePct').textContent='0%';return}if(_finIdx>=finData.length)_finIdx=0;var p=finData[_finIdx];if(!p)return;var te=p.exps.reduce(function(s,e){return s+e.amt},0);var rem=p.budget-te;var pct=p.budget>0?Math.round(te/p.budget*100):0;document.getElementById('finProjName').textContent=p.name;document.getElementById('finStats').innerHTML='<div class="fin-stat"><div class="fin-stat-l"><div class="fin-dot" style="background:var(--blue)"></div><span class="fin-lbl">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span></div><span class="fin-val" style="color:var(--blue)">'+p.budget+' <small style="font-size:12px">Ø±.Ø¹</small></span></div><div class="fin-stat"><div class="fin-stat-l"><div class="fin-dot" style="background:var(--red)"></div><span class="fin-lbl">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></div><span class="fin-val" style="color:var(--red)">'+te+' <small style="font-size:12px">Ø±.Ø¹</small></span></div><div class="fin-stat"><div class="fin-stat-l"><div class="fin-dot" style="background:var(--green)"></div><span class="fin-lbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span></div><span class="fin-val" style="color:var(--green)">'+rem+' <small style="font-size:12px">Ø±.Ø¹</small></span></div>';document.getElementById('gaugePct').textContent=pct+'%';if(gChart)gChart.destroy();gChart=new Chart(document.getElementById('gaugeChart'),{type:'doughnut',data:{datasets:[{data:[te,Math.max(rem,0)],backgroundColor:['rgba(239,68,68,.8)','rgba(52,211,153,.6)'],borderWidth:0,circumference:270,rotation:225}]},options:{responsive:true,maintainAspectRatio:true,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}}}});document.getElementById('expBody').innerHTML=p.exps.length?p.exps.map(function(e){return '<tr><td><b>'+e.type+'</b></td><td style="font-weight:800;font-family:Cairo;color:var(--red)">'+e.amt+' Ø±.Ø¹</td><td style="color:var(--t3)">'+e.inv+'</td><td><button class="act-btn del" onclick="delExpense('+e.id+')">ğŸ—‘ï¸</button></td></tr>'}).join(''):'<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--t3)">Ù„Ø§ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>';var tb=0,tex=0;document.getElementById('finSummary').innerHTML=finData.map(function(f){var ex=f.exps.reduce(function(s,e){return s+e.amt},0);tb+=f.budget;tex+=ex;var pc=f.budget>0?Math.round(ex/f.budget*100):0;return '<tr><td><b>'+f.name+'</b></td><td style="color:var(--blue);font-weight:700;font-family:Cairo">'+f.budget+'</td><td style="color:var(--red);font-weight:700;font-family:Cairo">'+ex+'</td><td style="color:var(--green);font-weight:700;font-family:Cairo">'+(f.budget-ex)+'</td><td><div style="display:flex;align-items:center;gap:6px"><div class="prog-bar" style="width:60px"><div class="fill" style="width:'+pc+'%;background:'+(pc>70?'var(--red)':'var(--blue)')+'"></div></div><span style="font-size:12px;font-family:Cairo">'+pc+'%</span></div></td></tr>'}).join('')+'<tr style="border-top:2px solid var(--bdr);font-weight:800"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td style="color:var(--blue);font-family:Cairo">'+tb+'</td><td style="color:var(--red);font-family:Cairo">'+tex+'</td><td style="color:var(--green);font-family:Cairo">'+(tb-tex)+'</td><td></td></tr>'}
async function addExpense(){var a=parseFloat(document.getElementById('eAmt').value);var b=parseFloat(document.getElementById('eBudget').value);if(!a&&!b){toast('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº');return}if(!finData[_finIdx])return;if(b){finData[_finIdx].budget=b;var pr=projects.find(function(p){return p.name===finData[_finIdx].name});if(pr){pr.budget=b;await dbUpdate('pms_projects',pr.id,{budget:b})}}if(a){var res=await dbInsert('pms_expenses',{project_name:finData[_finIdx].name,type:document.getElementById('eType').value,amount:a,invoice:document.getElementById('eInv').value||'-'});if(res&&res[0])finData[_finIdx].exps.push({id:res[0].id,type:res[0].type,amt:a,inv:res[0].invoice||'-'})}hideModal('expModal');renderFinance();toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');document.getElementById('eAmt').value='';document.getElementById('eBudget').value=''}
async function delExpense(id){if(!confirm('Ø­Ø°ÙØŸ'))return;await dbDelete('pms_expenses',id);finData[_finIdx].exps=finData[_finIdx].exps.filter(function(x){return x.id!==id});renderFinance();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}

// ===================== HR =====================
function renderHR(){var s=(document.getElementById('hrSearch')?document.getElementById('hrSearch').value:'').toLowerCase();var df=document.getElementById('hrDept')?document.getElementById('hrDept').value:'all';var all=getAllEmps();var f=all.filter(function(e){if(s&&!e.name.includes(s)&&!e.email.includes(s))return false;return df==='all'||e.dept===df});var avail=f.filter(function(e){return e.avail==='available'}).length;var busy=f.filter(function(e){return e.avail==='busy'}).length;document.getElementById('hrStats').innerHTML=[['blue','ğŸ‘¥','Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',f.length],['green','âœ…','Ù…ØªØ§Ø­ÙˆÙ†',avail],['orange','â±ï¸','Ù…Ø´ØºÙˆÙ„ÙˆÙ†',busy],['purple','ğŸ¢','Ø£Ù‚Ø³Ø§Ù…',new Set(f.map(function(e){return e.dept})).size]].map(function(x){return '<div class="st-card"><div style="position:absolute;top:0;right:0;left:0;height:3px;background:var(--'+x[0]+')"></div><div class="st-ic" style="background:rgba(56,189,248,.1)">'+x[1]+'</div><div class="st-lb">'+x[2]+'</div><div class="st-vl" style="color:var(--'+x[0]+')">'+x[3]+'</div></div>'}).join('');document.getElementById('hrDepts').innerHTML=depts.filter(function(d){return df==='all'||d.n===df}).map(function(d){var de=f.filter(function(e){return e.dept===d.n});return '<div class="dept-card open"><div class="dept-hd" onclick="this.parentElement.classList.toggle(\'open\')"><div class="dept-ic">'+d.i+'</div><div><div class="dept-nm">'+d.n+'</div><div class="dept-cnt">'+de.length+' Ù…ÙˆØ¸Ù</div></div><div class="dept-tgl">â–¼</div></div><div class="dept-bd">'+(de.length?de.map(function(e){return '<div class="emp-row"><div class="emp-av">ğŸ‘¤</div><div class="emp-info"><div class="emp-nm">'+e.name+'</div><div class="emp-rl">'+e.role+'</div></div><span class="badge '+(e.avail==='available'?'green':'orange')+'">'+(e.avail==='available'?'âœ“ Ù…ØªØ§Ø­':'â¬¤ Ù…Ø´ØºÙˆÙ„ ('+e.tasks+')')+'</span></div>'}).join(''):'<div style="padding:16px;text-align:center;color:var(--t3)">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>')+'</div></div>'}).join('');document.getElementById('hrBody').innerHTML=f.length?f.map(function(e){return '<tr><td><b>'+e.name+'</b></td><td><span class="badge '+(e.avail==='available'?'green':'orange')+'">'+(e.avail==='available'?'âœ“ Ù…ØªØ§Ø­':'â¬¤ Ù…Ø´ØºÙˆÙ„')+'</span></td><td style="color:var(--t3);font-size:13px">'+e.email+'</td><td><span class="badge gray">'+e.role+'</span></td><td><span class="badge blue">'+e.dept+'</span></td></tr>'}).join(''):'<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'}

// ===================== EVALUATIONS =====================
function starsHTML(v){var h='<span class="stars">';for(var i=1;i<=10;i++)h+='<span class="star'+(i<=v?' on':'')+'">â˜…</span>';return h+'</span> <b style="font-family:Cairo;font-size:15px;margin-right:4px">'+v+'</b>'}
function scCls(v){return v>=8?'green':v>=6?'blue':v>=4?'orange':'red'}
function renderEvals(){var s=(document.getElementById('evalSearch')?document.getElementById('evalSearch').value:'').toLowerCase();var f=evals.filter(function(e){return !s||e.emp.includes(s)||e.task.includes(s)});document.getElementById('evalBody').innerHTML=f.length?f.map(function(e){var t=e.s+e.q+e.p;return '<tr><td style="color:var(--blue);font-weight:700">'+e.emp+'</td><td><b>'+e.task+'</b></td><td>'+starsHTML(e.s)+'</td><td>'+starsHTML(e.q)+'</td><td>'+starsHTML(e.p)+'</td><td style="text-align:center"><span class="badge '+scCls(Math.round(t/3))+'"><b style="font-family:Cairo;font-size:15px">'+t+'</b>/30</span></td><td><button class="act-btn" style="color:var(--orange)" onclick="editEval('+e.id+')">âœï¸</button> <button class="act-btn del" onclick="delEval('+e.id+')">ğŸ—‘ï¸</button></td></tr>'}).join(''):'<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--t3)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª</td></tr>'}
async function addEval(){var res=await dbInsert('pms_evaluations',{employee:document.getElementById('evEmp').value,task:document.getElementById('evTask').value,speed:+document.getElementById('evS').value,quality:+document.getElementById('evQ').value,commitment:+document.getElementById('evP').value});if(res&&res[0])evals.push({id:res[0].id,emp:res[0].employee,task:res[0].task,s:res[0].speed,q:res[0].quality,p:res[0].commitment});hideModal('evalModal');renderEvals();toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…')}
async function delEval(id){if(!confirm('Ø­Ø°ÙØŸ'))return;await dbDelete('pms_evaluations',id);evals=evals.filter(function(x){return x.id!==id});renderEvals();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}
function editEval(id){var e=evals.find(function(x){return x.id===id});if(!e)return;showModal('evalModal');document.getElementById('evS').value=e.s;document.getElementById('evQ').value=e.q;document.getElementById('evP').value=e.p;setTimeout(function(){document.getElementById('evEmp').value=e.emp;document.getElementById('evTask').value=e.task},50);document.querySelector('#evalModal .f-submit').onclick=async function(){await dbUpdate('pms_evaluations',id,{employee:document.getElementById('evEmp').value,task:document.getElementById('evTask').value,speed:+document.getElementById('evS').value,quality:+document.getElementById('evQ').value,commitment:+document.getElementById('evP').value});e.emp=document.getElementById('evEmp').value;e.task=document.getElementById('evTask').value;e.s=+document.getElementById('evS').value;e.q=+document.getElementById('evQ').value;e.p=+document.getElementById('evP').value;hideModal('evalModal');document.querySelector('#evalModal .f-submit').onclick=function(){addEval()};renderEvals();toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…')}}

// ===================== USERS =====================
function renderUsers(){var s=(document.getElementById('userSearch')?document.getElementById('userSearch').value:'').toLowerCase();var rf=document.getElementById('userRoleF')?document.getElementById('userRoleF').value:'all';var f=users.filter(function(u){if(s&&!u.n.includes(s)&&!u.u.includes(s))return false;return rf==='all'||u.r===rf});document.getElementById('userStats').innerHTML=[['blue','ğŸ‘¥','Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',users.length],['purple','ğŸ›¡ï¸','Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…',users.filter(function(u){return u.r==='super_admin'}).length],['green','ğŸ“','Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹',users.filter(function(u){return u.r==='project_manager'}).length],['orange','ğŸ‘¤','Ù…ÙˆØ¸ÙÙŠÙ†',users.filter(function(u){return u.r!=='super_admin'&&u.r!=='project_manager'}).length]].map(function(x){return '<div class="st-card"><div style="position:absolute;top:0;right:0;left:0;height:3px;background:var(--'+x[0]+')"></div><div class="st-ic" style="background:rgba(56,189,248,.1)">'+x[1]+'</div><div class="st-lb">'+x[2]+'</div><div class="st-vl" style="color:var(--'+x[0]+')">'+x[3]+'</div></div>'}).join('');document.getElementById('userBody').innerHTML=f.length?f.map(function(u){var rc=u.r==='super_admin'?'purple':u.r==='project_manager'?'blue':'gray';return '<tr><td><div style="display:flex;align-items:center;gap:10px"><div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--cyan));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px">'+u.n[0]+'</div><div><b style="font-size:14px">'+u.n+'</b><div style="font-size:11px;color:var(--t3)">@'+u.u+'</div></div></div></td><td style="font-size:13px;color:var(--t3)">'+(u.email||'-')+'</td><td><span class="badge '+rc+'">'+RL[u.r]+'</span></td><td><span class="badge blue">'+(u.dept||'-')+'</span></td><td style="font-size:13px">'+(u.jobTitle||'-')+'</td><td><button class="act-btn" style="color:var(--blue)" onclick="viewProfile('+u.id+')">ğŸ‘¤</button> <button class="act-btn" style="color:var(--orange)" onclick="editUser('+u.id+')">âœï¸</button>'+(u.u!=='admin'?' <button class="act-btn del" onclick="delUser('+u.id+')">ğŸ—‘ï¸</button>':'')+'</td></tr>'}).join(''):''}
async function saveUser(){var n=document.getElementById('uName').value.trim();var uu=document.getElementById('uUser').value.trim();var pp=document.getElementById('uPass').value;if(!n||!uu){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');return}var editId=document.getElementById('uEditId').value;if(editId){var u=users.find(function(x){return x.id===parseInt(editId)});if(u){var upd={fullname:n,username:uu,email:document.getElementById('uEmail').value,role:document.getElementById('uRole').value,dept:document.getElementById('uDept').value,job_title:document.getElementById('uJobTitle').value,phone:document.getElementById('uPhone').value};if(pp)upd.password=pp;await dbUpdate('pms_users',parseInt(editId),upd);u.n=n;u.u=uu;if(pp)u.p=pp;u.email=upd.email;u.r=upd.role;u.dept=upd.dept;u.jobTitle=upd.job_title;u.phone=upd.phone}}else{if(!pp){toast('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');return}if(users.find(function(x){return x.u===uu})){toast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯');return}var res=await dbInsert('pms_users',{username:uu,password:pp,fullname:n,role:document.getElementById('uRole').value,email:document.getElementById('uEmail').value,dept:document.getElementById('uDept').value,job_title:document.getElementById('uJobTitle').value,phone:document.getElementById('uPhone').value});if(res&&res[0])users.push({id:res[0].id,u:uu,p:pp,n:n,r:res[0].role,email:res[0].email,dept:res[0].dept,jobTitle:res[0].job_title,phone:res[0].phone})}hideModal('userModal');clearUF();renderUI();toast(editId?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…':'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…')}
function editUser(id){var u=users.find(function(x){return x.id===id});if(!u)return;document.getElementById('userModalTitle').textContent='ØªØ¹Ø¯ÙŠÙ„';document.getElementById('uEditId').value=id;document.getElementById('uName').value=u.n;document.getElementById('uUser').value=u.u;document.getElementById('uPass').value='';document.getElementById('uEmail').value=u.email||'';document.getElementById('uRole').value=u.r;document.getElementById('uDept').value=u.dept||'ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª';document.getElementById('uJobTitle').value=u.jobTitle||'';document.getElementById('uPhone').value=u.phone||'';showModal('userModal')}
async function delUser(id){var u=users.find(function(x){return x.id===id});if(!u||u.u==='admin')return;if(!confirm('Ø­Ø°Ù '+u.n+'ØŸ'))return;await dbDelete('pms_users',id);users=users.filter(function(x){return x.id!==id});renderUI();toast('ØªÙ… Ø§Ù„Ø­Ø°Ù')}
function clearUF(){document.getElementById('userModalTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…';document.getElementById('uEditId').value='';['uName','uUser','uPass','uEmail','uJobTitle','uPhone'].forEach(function(x){document.getElementById(x).value=''})}
function viewProfile(id){var u=users.find(function(x){return x.id===id});if(!u)return;var tc=tasks.filter(function(t){return t.assign===u.n}).length;var cc=tasks.filter(function(t){return t.assign===u.n&&t.st==='completed'}).length;var el=evals.filter(function(e){return e.emp===u.n});var avg=el.length?el.reduce(function(s,e){return s+e.s+e.q+e.p},0)/(el.length*3):0;var rc=u.r==='super_admin'?'purple':u.r==='project_manager'?'blue':'gray';document.getElementById('profileContent').innerHTML='<div style="text-align:center;padding:20px 0"><div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--cyan));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:32px;margin:0 auto 12px;font-family:Cairo">'+u.n[0]+'</div><div style="font-size:22px;font-weight:800;font-family:Cairo">'+u.n+'</div><div style="color:var(--t3);font-size:14px">@'+u.u+'</div><span class="badge '+rc+'" style="margin-top:8px">'+RL[u.r]+'</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">'+ [['Ø§Ù„Ø¨Ø±ÙŠØ¯',u.email||'-'],['Ø§Ù„Ù‡Ø§ØªÙ',u.phone||'-'],['Ø§Ù„Ù‚Ø³Ù…',u.dept||'-'],['Ø§Ù„ÙˆØ¸ÙŠÙØ©',u.jobTitle||'-']].map(function(x){return '<div style="background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;padding:14px;text-align:center"><div style="font-size:12px;color:var(--t3)">'+x[0]+'</div><div style="font-weight:700;font-size:14px;margin-top:4px">'+x[1]+'</div></div>'}).join('') +'</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:12px 0"><div style="background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.12);border-radius:10px;padding:16px;text-align:center"><div style="font-size:24px;font-weight:900;font-family:Cairo;color:var(--blue)">'+tc+'</div><div style="font-size:12px;color:var(--t3)">Ø§Ù„Ù…Ù‡Ø§Ù…</div></div><div style="background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.12);border-radius:10px;padding:16px;text-align:center"><div style="font-size:24px;font-weight:900;font-family:Cairo;color:var(--green)">'+cc+'</div><div style="font-size:12px;color:var(--t3)">Ù…ÙƒØªÙ…Ù„Ø©</div></div><div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.12);border-radius:10px;padding:16px;text-align:center"><div style="font-size:24px;font-weight:900;font-family:Cairo;color:var(--orange)">'+avg.toFixed(1)+'</div><div style="font-size:12px;color:var(--t3)">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div></div></div>';showModal('profileModal')}

// ===================== MODALS =====================
function showModal(id){if(id==='userModal'&&!document.getElementById('uEditId').value)clearUF();var eo=users.map(function(u){return '<option>'+u.n+'</option>'}).join('');var po=projects.map(function(p){return '<option>'+p.name+'</option>'}).join('');var to=tasks.map(function(t){return '<option>'+t.name+'</option>'}).join('');if(document.getElementById('pMgr'))document.getElementById('pMgr').innerHTML=eo||'<option>Ø£Ø¶Ù Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>';if(document.getElementById('tProj'))document.getElementById('tProj').innerHTML=po||'<option>Ø£Ø¶Ù Ù…Ø´Ø§Ø±ÙŠØ¹</option>';if(document.getElementById('tAssign'))document.getElementById('tAssign').innerHTML=eo||'<option>Ø£Ø¶Ù Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>';if(document.getElementById('evEmp'))document.getElementById('evEmp').innerHTML=eo||'<option>Ø£Ø¶Ù Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>';if(document.getElementById('evTask'))document.getElementById('evTask').innerHTML=to||'<option>Ø£Ø¶Ù Ù…Ù‡Ø§Ù…</option>';document.getElementById(id).classList.add('show')}
function hideModal(id){document.getElementById(id).classList.remove('show')}

// ===================== AI =====================
function showAI(type){showModal('aiModal');document.getElementById('aiContent').innerHTML='<div style="text-align:center;padding:30px"><div class="spinner"></div><p style="color:var(--t2)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p></div>';setTimeout(function(){var h='';var emps=getAllEmps();if(type==='dash'||type==='reports'){var avgP=projects.length?(projects.reduce(function(s,p){return s+p.prog},0)/projects.length).toFixed(1):0;var hiRisk=projects.filter(function(p){return p.risk==='Ø¹Ø§Ù„ÙŠ'}).length;var overdue=tasks.filter(function(t){return t.due&&new Date(t.due)<new Date()&&t.st!=='completed'}).length;var rate=tasks.length?Math.round(tasks.filter(function(t){return t.st==='completed'}).length/tasks.length*100):0;h='<div class="ai-card"><h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„</h4><p>'+projects.length+' Ù…Ø´Ø§Ø±ÙŠØ¹ Ù†Ø´Ø·Ø©. Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù… <b>'+avgP+'%</b>. Ù…Ø¹Ø¯Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ø§Ù… <b>'+rate+'%</b>.</p></div><div class="ai-card"><h4>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‡Ø§Ù…Ø©</h4><p>'+(hiRisk?'<b style="color:var(--red)">'+hiRisk+'</b> Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ© ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ÙÙˆØ±ÙŠØ©.<br>':'')+(overdue?'<b style="color:var(--orange)">'+overdue+'</b> Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù† Ù…ÙˆØ¹Ø¯Ù‡Ø§.<br>':'')+(!hiRisk&&!overdue?'âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.':'')+'</p></div><div class="ai-card"><h4>âœ… ØªÙˆØµÙŠØ§Øª Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</h4><p>'+(!projects.length?'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆÙ…Ù‡Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¯Ù‚ÙŠÙ‚.':'1. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±<br>2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†<br>3. ØªØªØ¨Ø¹ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ø³ÙŠÙ†<br>4. ØªØ­Ø¯ÙŠØ« Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø´ÙƒÙ„ Ù…Ù†ØªØ¸Ù…')+'</p></div><div class="ai-card"><h4>ğŸ“ˆ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4><p>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ÙˆÙ†: <b style="color:var(--green)">'+emps.filter(function(e){return e.avail==='available'}).length+'</b> Ù…Ù† Ø£ØµÙ„ '+emps.length+'<br>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: <b style="color:var(--blue)">'+projects.filter(function(p){return p.status==='Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}).length+'</b></p></div>'}else if(type==='hr'){var avail=emps.filter(function(e){return e.avail==='available'}).length;h='<div class="ai-card"><h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h4><p>'+emps.length+' Ù…ÙˆØ¸Ù. <b style="color:var(--green)">'+avail+'</b> Ù…ØªØ§Ø­ÙˆÙ† Ùˆ<b style="color:var(--orange)">'+(emps.length-avail)+'</b> Ù…Ø´ØºÙˆÙ„ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div><div class="ai-card"><h4>âœ… ØªÙˆØµÙŠØ§Øª</h4><p>'+(emps.length<3?'ÙØ±ÙŠÙ‚ ØµØºÙŠØ± - ÙŠÙÙ†ØµØ­ Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ÙˆØ¸ÙÙŠÙ† Ø¥Ø¶Ø§ÙÙŠÙŠÙ†.':'1. Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©<br>2. Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø¨Ø¡ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…<br>3. ÙˆØ¶Ø¹ Ø®Ø·Ø© ØªØ¯Ø±ÙŠØ¨ ÙˆØªØ·ÙˆÙŠØ±<br>4. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø­Ù…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ Ø´Ù‡Ø±ÙŠØ§Ù‹')+'</p></div>'}else{var st={};evals.forEach(function(e){if(!st[e.emp])st[e.emp]={c:0,s:0};st[e.emp].c++;st[e.emp].s+=e.s+e.q+e.p});var b='',ba=0;Object.entries(st).forEach(function(x){var a=x[1].s/(x[1].c*3);if(a>ba){ba=a;b=x[0]}});h=evals.length?'<div class="ai-card"><h4>ğŸ† Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡</h4><p><b style="color:var(--gold)">'+b+'</b> Ø¨Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… <b>'+ba.toFixed(1)+'</b> Ù…Ù† 10</p></div><div class="ai-card"><h4>ğŸ“ˆ ØªÙˆØµÙŠØ§Øª</h4><p>1. Ø±Ø¨Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª<br>2. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ù‡Ø±ÙŠØ© Ù…Ù†ØªØ¸Ù…Ø©<br>3. ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©<br>4. Ù…Ø´Ø§Ø±ÙƒØ© Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª</p></div>':'<div class="ai-card"><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙƒØ§ÙÙŠØ©</h4><p>Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø¯Ù‚ÙŠÙ‚.</p></div>'}document.getElementById('aiContent').innerHTML=h},1200)}

function toast(m,c){var t=document.createElement('div');t.className='toast';t.textContent=m;if(c)t.style.background=c;document.body.appendChild(t);setTimeout(function(){t.remove()},2500)}
</script>
</body>
</html>
